{
    "comments": [
        {
            "author": "Peter Lancaster",
            "body": "I found a workaround, but it would be nice if this problem could be solved more elegantly.\n\nSince the file was being downloaded in its entirety, I added some code to ignore the EOFException.\n\nif (responseCode == HttpStatus.SC_OK && entity != null) {\n\t\t\t\t\toutStream = new BufferedOutputStream(new FileOutputStream(outFilename));\n\t\t\t\t\tlong length = entity.getContentLength();\n\t\t\t\t\ttry {\n\t\t\t\t\t\tentity.writeTo(outStream);\n\t\t\t\t\t} catch (EOFException e) {\n\t\t\t\t\t\t// Sometimes we get EOFExceptions if the content length\n\t\t\t\t\t\t// wasn't specified by the server.  Ignore these but report\n\t\t\t\t\t\t// those where the content length was specified.\n\t\t\t\t\t\tif (length >= 0) {\n\t\t\t\t\t\t\tthrow e;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}",
            "date": "2011-08-02T12:22:12.339+0000",
            "id": 0
        },
        {
            "author": "Oleg Kalnichevski",
            "body": "This is a duplicate of HTTPCLIENT-1075.\n\nOleg",
            "date": "2011-08-03T11:36:17.800+0000",
            "id": 1
        },
        {
            "author": "Guido Serra aka Zeph",
            "body": "might be also a duplicate of HTTPCLIENT-1281 ?",
            "date": "2013-03-18T09:20:14.656+0000",
            "id": 2
        }
    ],
    "component": "HttpClient (classic)",
    "description": "Hello I am getting an exception when I try to download certain files.\n\nI don't have control over the host server, only the client.  Here's my client code:\n\n\t\tHttpParams params = new BasicHttpParams();\n\t\tparams.setParameter(CoreConnectionPNames.CONNECTION_TIMEOUT, 300000L);\n\t\tparams.setParameter(ClientPNames.HANDLE_REDIRECTS, true);\n\n\t\t// This client indicates to servers that it will support 'gzip'\n\t\t// and 'deflate' compressed responses.\n\t\tContentEncodingHttpClient.setDefaultHttpParams(params);\n\t\tContentEncodingHttpClient client = new ContentEncodingHttpClient();\n\n\t\tif (user != null && password != null) {\n\t\t\tString hostname = url.getHost();\n\t\t\tHttpHost hostHttp = new HttpHost(hostname, 80, \"http\");\n\t\t\tHttpHost hostHttps = new HttpHost(hostname, 443, \"https\");\n\t\t\tclient.getCredentialsProvider().setCredentials(\n\t\t\t        new AuthScope(hostname, 80), \n\t\t\t        new UsernamePasswordCredentials(user, password));\n\t\n\t\t\tclient.getCredentialsProvider().setCredentials(\n\t\t\t        new AuthScope(hostname, 443), \n\t\t\t        new UsernamePasswordCredentials(user, password));\n\t\n\t\t\t// Create AuthCache instance\n\t\t\tAuthCache authCache = new BasicAuthCache();\n\t\t\t// Generate BASIC scheme object and add it to the local auth cache\n\t\t\tBasicScheme basicAuth = new BasicScheme();\n\t\t\tauthCache.put(hostHttp, basicAuth);\n\t\t\tauthCache.put(hostHttps, basicAuth);\n\t\n\t\t\t// Add AuthCache to the execution context\n\t\t\tBasicHttpContext localcontext = new BasicHttpContext();\n\t\t\tlocalcontext.setAttribute(ClientContext.AUTH_CACHE, authCache);\n\t\t}\n\t\tHttpGet httpget = new HttpGet(url.toString());\n\t\thttpget.setHeader(\"If-Modified-Since\", lastModified);\n\n\n\t\tHttpResponse response = client.execute(httpget);\n\t\tresponseCode = response.getStatusLine().getStatusCode();\n\t\tHttpEntity entity = response.getEntity();\n\t\tif (responseCode == HttpStatus.SC_NOT_MODIFIED) {\n\t\t\t\n\t\t} else if (responseCode == HttpStatus.SC_OK && entity != null) {\n\t\t\toutStream = new BufferedOutputStream(new FileOutputStream(outFilename));\n\t\t\tentity.writeTo(outStream);\n\t\t}\n\nHere's the log output:\n\nDEBUG [2011-08-02 01:23:01,031] [org.apache.http.impl.conn.SingleClientConnManager:212] Get connection for route HttpRoute[{}->http://<host>]\nDEBUG [2011-08-02 01:23:01,036] [org.apache.http.impl.conn.DefaultClientConnectionOperator:145] Connecting to <host>/<IP>:80\nDEBUG [2011-08-02 01:23:01,057] [org.apache.http.client.protocol.RequestAddCookies:132] CookieSpec selected: best-match\nDEBUG [2011-08-02 01:23:01,057] [org.apache.http.client.protocol.RequestAuthCache:75]   Auth cache not set in the context\nDEBUG [2011-08-02 01:23:01,058] [org.apache.http.impl.client.DefaultRequestDirector:631]        Attempt 1 to execute request\nDEBUG [2011-08-02 01:23:01,058] [org.apache.http.impl.conn.DefaultClientConnection:264] Sending request: GET <file> HTTP/1.1\nDEBUG [2011-08-02 01:23:01,058] [org.apache.http.impl.conn.Wire:63]     >> \"GET <file> HTTP/1.1[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,058] [org.apache.http.impl.conn.Wire:63]     >> \"If-Modified-Since: Mon, 01 Aug 2011 18:26:09 CEST[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,059] [org.apache.http.impl.conn.Wire:63]     >> \"Host: <host>[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,059] [org.apache.http.impl.conn.Wire:63]     >> \"Connection: Keep-Alive[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,059] [org.apache.http.impl.conn.Wire:63]     >> \"User-Agent: Apache-HttpClient/4.1.1 (java 1.5)[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,059] [org.apache.http.impl.conn.Wire:63]     >> \"Accept-Encoding: gzip,deflate[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,060] [org.apache.http.impl.conn.Wire:63]     >> \"[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,060] [org.apache.http.impl.conn.DefaultClientConnection:268] >> GET <file> HTTP/1.1\nDEBUG [2011-08-02 01:23:01,060] [org.apache.http.impl.conn.DefaultClientConnection:271] >> If-Modified-Since: Mon, 01 Aug 2011 18:26:09 CEST\nDEBUG [2011-08-02 01:23:01,060] [org.apache.http.impl.conn.DefaultClientConnection:271] >> Host: <host>\nDEBUG [2011-08-02 01:23:01,061] [org.apache.http.impl.conn.DefaultClientConnection:271] >> Connection: Keep-Alive\nDEBUG [2011-08-02 01:23:01,061] [org.apache.http.impl.conn.DefaultClientConnection:271] >> User-Agent: Apache-HttpClient/4.1.1 (java 1.5)\nDEBUG [2011-08-02 01:23:01,061] [org.apache.http.impl.conn.DefaultClientConnection:271] >> Accept-Encoding: gzip,deflate\nDEBUG [2011-08-02 01:23:01,085] [org.apache.http.impl.conn.Wire:63]     << \"HTTP/1.1 200 OK[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,086] [org.apache.http.impl.conn.Wire:63]     << \"Server: nginx/0.8.54[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,086] [org.apache.http.impl.conn.Wire:63]     << \"Date: Mon, 01 Aug 2011 23:23:01 GMT[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,086] [org.apache.http.impl.conn.Wire:63]     << \"Content-Type: text/plain[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,086] [org.apache.http.impl.conn.Wire:63]     << \"Last-Modified: Wed, 20 Jul 2011 14:39:57 GMT[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,087] [org.apache.http.impl.conn.Wire:63]     << \"Transfer-Encoding: chunked[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,087] [org.apache.http.impl.conn.Wire:63]     << \"Connection: keep-alive[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,087] [org.apache.http.impl.conn.Wire:63]     << \"Vary: Accept-Encoding[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,087] [org.apache.http.impl.conn.Wire:63]     << \"Expires: Wed, 31 Aug 2011 23:23:01 GMT[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,088] [org.apache.http.impl.conn.Wire:63]     << \"Cache-Control: max-age=2592000[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,088] [org.apache.http.impl.conn.Wire:63]     << \"Content-Encoding: gzip[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,088] [org.apache.http.impl.conn.Wire:63]     << \"[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,088] [org.apache.http.impl.conn.DefaultClientConnection:249] Receiving response: HTTP/1.1 200 OK\nDEBUG [2011-08-02 01:23:01,089] [org.apache.http.impl.conn.DefaultClientConnection:252] << HTTP/1.1 200 OK\nDEBUG [2011-08-02 01:23:01,089] [org.apache.http.impl.conn.DefaultClientConnection:255] << Server: nginx/0.8.54\nDEBUG [2011-08-02 01:23:01,089] [org.apache.http.impl.conn.DefaultClientConnection:255] << Date: Mon, 01 Aug 2011 23:23:01 GMT\nDEBUG [2011-08-02 01:23:01,089] [org.apache.http.impl.conn.DefaultClientConnection:255] << Content-Type: text/plain\nDEBUG [2011-08-02 01:23:01,089] [org.apache.http.impl.conn.DefaultClientConnection:255] << Last-Modified: Wed, 20 Jul 2011 14:39:57 GMT\nDEBUG [2011-08-02 01:23:01,090] [org.apache.http.impl.conn.DefaultClientConnection:255] << Transfer-Encoding: chunked\nDEBUG [2011-08-02 01:23:01,090] [org.apache.http.impl.conn.DefaultClientConnection:255] << Connection: keep-alive\nDEBUG [2011-08-02 01:23:01,090] [org.apache.http.impl.conn.DefaultClientConnection:255] << Vary: Accept-Encoding\nDEBUG [2011-08-02 01:23:01,090] [org.apache.http.impl.conn.DefaultClientConnection:255] << Expires: Wed, 31 Aug 2011 23:23:01 GMT\nDEBUG [2011-08-02 01:23:01,090] [org.apache.http.impl.conn.DefaultClientConnection:255] << Cache-Control: max-age=2592000\nDEBUG [2011-08-02 01:23:01,091] [org.apache.http.impl.conn.DefaultClientConnection:255] << Content-Encoding: gzip\nDEBUG [2011-08-02 01:23:01,091] [org.apache.http.impl.client.DefaultRequestDirector:477]        Connection can be kept alive indefinitely\nDEBUG [2011-08-02 01:23:01,131] [org.apache.http.impl.conn.Wire:63]     << \"600a[\\r][\\n]\"\nDEBUG [2011-08-02 01:23:01,132] [org.apache.http.impl.conn.Wire:77]     << \"[0x1f]\"\nDEBUG [2011-08-02 01:23:03,838] [org.apache.http.impl.conn.Wire:63]     << \"[\\r][\\n]\"\n\n.... (Content)\n\nDEBUG [2011-08-02 01:23:03,839] [org.apache.http.impl.conn.SingleClientConnManager:267] Releasing connection org.apache.http.impl.conn.SingleClientConnManager$ConnAdapter@2aa3873\nDEBUG [2011-08-02 01:23:03,839] [org.apache.http.impl.conn.SingleClientConnManager:285] Released connection open but not reusable.\nDEBUG [2011-08-02 01:23:03,839] [org.apache.http.impl.conn.DefaultClientConnection:152] Connection shut down\nERROR [2011-08-02 01:23:03,840] [app]        Exception downloading file\njava.io.EOFException\n        at java.util.zip.GZIPInputStream.readUByte(GZIPInputStream.java:224)\n        at java.util.zip.GZIPInputStream.readUShort(GZIPInputStream.java:214)\n        at java.util.zip.GZIPInputStream.readHeader(GZIPInputStream.java:153)\n        at java.util.zip.GZIPInputStream.<init>(GZIPInputStream.java:75)\n        at java.util.zip.GZIPInputStream.<init>(GZIPInputStream.java:85)\n        at org.apache.http.client.entity.GzipDecompressingEntity.getContent(GzipDecompressingEntity.java:63)\n        at org.apache.http.util.EntityUtils.consume(EntityUtils.java:65)\n        at org.apache.http.conn.BasicManagedEntity.ensureConsumed(BasicManagedEntity.java:98)\n        at org.apache.http.conn.BasicManagedEntity.writeTo(BasicManagedEntity.java:115)\n        at util.FileDownload.download(FileDownload.java:188) <--- my app\n\nDoes this happen because the server doesn't specify the content length?",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "HTTPCLIENT-1113",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "HTTPCLIENT",
    "project": "HTTPCLIENT",
    "summary": "Error downloading text file with gzip content encoding",
    "systemSpecification": true,
    "version": "4.1.1"
}