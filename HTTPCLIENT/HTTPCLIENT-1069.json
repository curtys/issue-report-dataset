{
    "comments": [
        {
            "author": "Oleg Kalnichevski",
            "body": "Fixed in trunk and 4.1.x branch. Please re-test.\n\nOleg",
            "date": "2011-03-10T09:44:22.749+0000",
            "id": 0
        },
        {
            "author": "Michael Leonhard",
            "body": "I can confirm that this is fixed in the 4.1.x branch.  Thank you!\n-Michael\n\nC:\\RetryBug>\"c:\\Program Files (x86)\\Java\\jdk1.6.0_21\\bin\\javac.exe\" -cp httpclient-4.1.x\\httpclient\\target\\httpclient-4.1.1-SNAPSHOT.jar;httpcomponents-client-4.1\\lib\\commons-codec-1.4.jar;httpcomponents-client-4.1\\lib\\commons-logging-1.1.1.jar;httpcomponents-client-4.1\\lib\\httpcore-4.1.jar RetryBug.java\n\nC:\\RetryBug>\"c:\\Program Files (x86)\\Java\\jdk1.6.0_21\\bin\\java.exe\" -cp httpclient-4.1.x\\httpclient\\target\\httpclient-4.1.1-SNAPSHOT.jar;httpcomponents-client-4.1\\lib\\commons-codec-1.4.jar;httpcomponents-client-4.1\\lib\\commons-logging-1.1.1.jar;httpcomponents-client-4.1\\lib\\httpcore-4.1.jar;. RetryBug\nMar 10, 2011 9:58:02 PM RetryBug$1 retryRequest\nINFO: count=1 java.net.SocketTimeoutException: Read timed out\nMar 10, 2011 9:58:02 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (java.net.SocketTimeoutException) caught when processing request: Read timed out\nMar 10, 2011 9:58:02 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 10, 2011 9:58:03 PM RetryBug$1 retryRequest\nINFO: count=2 org.apache.http.conn.HttpHostConnectException: Connection to http://127.0.0.1:56928 refused\nMar 10, 2011 9:58:03 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (org.apache.http.conn.HttpHostConnectException) caught when processing request: Connection to http://127.0.0.1:56928 refused\nMar 10, 2011 9:58:03 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 10, 2011 9:58:04 PM RetryBug$1 retryRequest\nINFO: count=3 org.apache.http.conn.HttpHostConnectException: Connection to http://127.0.0.1:56928 refused\nMar 10, 2011 9:58:04 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (org.apache.http.conn.HttpHostConnectException) caught when processing request: Connection to http://127.0.0.1:56928 refused\nMar 10, 2011 9:58:04 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 10, 2011 9:58:05 PM RetryBug$1 retryRequest\nINFO: count=4 org.apache.http.conn.HttpHostConnectException: Connection to http://127.0.0.1:56928 refused\nMar 10, 2011 9:58:05 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (org.apache.http.conn.HttpHostConnectException) caught when processing request: Connection to http://127.0.0.1:56928 refused\nMar 10, 2011 9:58:05 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 10, 2011 9:58:06 PM RetryBug$1 retryRequest\nINFO: count=5 org.apache.http.conn.HttpHostConnectException: Connection to http://127.0.0.1:56928 refused\nException in thread \"main\" org.apache.http.conn.HttpHostConnectException: Connection to http://127.0.0.1:56928 refused\n        at org.apache.http.impl.conn.DefaultClientConnectionOperator.openConnection(DefaultClientConnectionOperator.java:158)\n        at org.apache.http.impl.conn.AbstractPoolEntry.open(AbstractPoolEntry.java:149)\n        at org.apache.http.impl.conn.AbstractPooledConnAdapter.open(AbstractPooledConnAdapter.java:121)\n        at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:622)\n        at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:454)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:820)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:754)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:732)\n        at RetryBug.main(RetryBug.java:27)\nCaused by: java.net.ConnectException: Connection refused: connect\n        at java.net.PlainSocketImpl.socketConnect(Native Method)\n        at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:333)\n        at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:195)\n        at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:182)\n        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)\n        at java.net.Socket.connect(Socket.java:529)\n        at org.apache.http.conn.scheme.PlainSocketFactory.connectSocket(PlainSocketFactory.java:123)\n        at org.apache.http.impl.conn.DefaultClientConnectionOperator.openConnection(DefaultClientConnectionOperator.java:148)\n        ... 8 more\n\nC:\\RetryBug>",
            "date": "2011-03-10T14:01:31.586+0000",
            "id": 1
        }
    ],
    "component": "HttpClient (classic)",
    "description": "I encountered an issue while writing unit tests for the RestBackup(tm) API Client Library, https://github.com/mleonhard/restbackup-java .  HttpClient 4.1 is failing to retry when it encounters a read timeout followed by a connection refusal.  This problem occurs on Windows but not on Linux.  Below is a short program that reproduces the problem.  It performs the expected 5 request attempts on Linux but only 2 on Windows.\n\nMy Windows environment is a laptop with Windows 7 Ultimate 64-bit and Oracle Java SE Development Kit Update 21 32-bit.  My Linux environment is Amazon EC2 with Ubuntu 10.04 LTS 32-bit and Oracle Java SE Development Kit Update 21 32-bit.\n\nThis is my first bug report to an Apache project.  I'd like to add that I'm a big fan of the Commons libraries and Http Components.\n\nSincerely,\n-Michael\n\n=== RetryBug.java ===\n\nimport java.io.IOException;\nimport java.net.ServerSocket;\nimport java.util.logging.Logger;\n\nimport org.apache.http.client.HttpRequestRetryHandler;\nimport org.apache.http.client.methods.HttpGet;\nimport org.apache.http.impl.client.DefaultHttpClient;\nimport org.apache.http.params.CoreConnectionPNames;\nimport org.apache.http.protocol.HttpContext;\n\npublic class RetryBug {\n    private static final Logger _log = Logger.getLogger(RetryBug.class.getName());\n\n    public static void main(String[] args) throws IOException {\n        ServerSocket serverSocket = new ServerSocket(0, 1);\n        DefaultHttpClient httpClient = new DefaultHttpClient();\n        HttpRequestRetryHandler retryHandler = new HttpRequestRetryHandler() {\n                public boolean retryRequest(IOException e, int count, HttpContext context) {\n                    _log.info(\"count=\" + count + \" \" + e.toString());\n                    return count < 5;\n                }\n            };\n        httpClient.setHttpRequestRetryHandler(retryHandler);\n        httpClient.getParams().setIntParameter(CoreConnectionPNames.SO_TIMEOUT, 100);\n        try {\n            String url = \"http://127.0.0.1:\" + serverSocket.getLocalPort() + \"/\";\n            httpClient.execute(new HttpGet(url));\n        } finally {\n            serverSocket.close();\n        }\n    }\n}\n\n\n=== Windows 7 ===\n\nC:\\RetryBug>md5sum httpcomponents-client-4.1-bin.zip\n008ad15560249bcde42cfe34fdb4e858 *httpcomponents-client-4.1-bin.zip\n\nC:\\RetryBug>\"c:\\Program Files (x86)\\Java\\jdk1.6.0_21\\bin\\java.exe\" -version\njava version \"1.6.0_21\"\nJava(TM) SE Runtime Environment (build 1.6.0_21-b06)\nJava HotSpot(TM) Client VM (build 17.0-b16, mixed mode)\n\nC:\\RetryBug>\"c:\\Program Files (x86)\\Java\\jdk1.6.0_21\\bin\\javac.exe\" -cp httpcomponents-client-4.1\\lib\\commons-codec-1.4.jar;httpcomponents-client-4.1\\lib\\commons-logging-1.1.1.jar;httpcomponents-client-4.1\\lib\\httpclient-4.1.jar;httpcomponents-client-4.1\\lib\\httpcore-4.1.jar RetryBug.java\n\nC:\\RetryBug>\"c:\\Program Files (x86)\\Java\\jdk1.6.0_21\\bin\\java.exe\" -cp httpcomponents-client-4.1\\lib\\commons-codec-1.4.jar;httpcomponents-client-4.1\\lib\\commons-logging-1.1.1.jar;httpcomponents-client-4.1\\lib\\httpclient-4.1.jar;httpcomponents-client-4.1\\lib\\httpcore-4.1.jar;. RetryBug\nMar 9, 2011 9:14:36 PM RetryBug$1 retryRequest\nINFO: count=1 java.net.SocketTimeoutException: Read timed out\nMar 9, 2011 9:14:36 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (java.net.SocketTimeoutException) caught when processing request: Read timed out\nMar 9, 2011 9:14:36 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nException in thread \"main\" org.apache.http.conn.HttpHostConnectException: Connection to http://127.0.0.1:56361 refused\n        at org.apache.http.impl.conn.DefaultClientConnectionOperator.openConnection(DefaultClientConnectionOperator.java:158)\n        at org.apache.http.impl.conn.AbstractPoolEntry.open(AbstractPoolEntry.java:149)\n        at org.apache.http.impl.conn.AbstractPooledConnAdapter.open(AbstractPooledConnAdapter.java:121)\n        at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:650)\n        at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:454)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:820)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:754)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:732)\n        at RetryBug.main(RetryBug.java:27)\nCaused by: java.net.ConnectException: Connection refused: connect\n        at java.net.PlainSocketImpl.socketConnect(Native Method)\n        at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:333)\n        at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:195)\n        at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:182)\n        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)\n        at java.net.Socket.connect(Socket.java:529)\n        at org.apache.http.conn.scheme.PlainSocketFactory.connectSocket(PlainSocketFactory.java:120)\n        at org.apache.http.impl.conn.DefaultClientConnectionOperator.openConnection(DefaultClientConnectionOperator.java:148)\n        ... 8 more\n\nC:\\RetryBug>\n\n\n=== Ubuntu 10 ===\n\n$ md5sum httpcomponents-client-4.1-bin.tar.gz\nf043c1cc016cb3b720be9fb020bfa755  httpcomponents-client-4.1-bin.tar.gz\n$ ~/jdk1.6.0_21/bin/java -version\njava version \"1.6.0_21\"\nJava(TM) SE Runtime Environment (build 1.6.0_21-b06)\nJava HotSpot(TM) Client VM (build 17.0-b16, mixed mode, sharing)\n$ ~/jdk1.6.0_21/bin/javac -cp httpcomponents-client-4.1/lib/httpclient-cache-4.1.jar:httpcomponents-client-4.1/lib/commons-logging-1.1.1.jar:httpcomponents-client-4.1/lib/httpcore-4.1.jar:httpcomponents-client-4.1/lib/httpclient-4.1.jar:httpcomponents-client-4.1/lib/httpmime-4.1.jar:httpcomponents-client-4.1/lib/commons-codec-1.4.jar RetryBug.java\n$ ~/jdk1.6.0_21/bin/java -cp httpcomponents-client-4.1/lib/httpclient-cache-4.1.jar:httpcomponents-client-4.1/lib/commons-logging-1.1.1.jar:httpcomponents-client-4.1/lib/httpcore-4.1.jar:httpcomponents-client-4.1/lib/httpclient-4.1.jar:httpcomponents-client-4.1/lib/httpmime-4.1.jar:httpcomponents-client-4.1/lib/commons-codec-1.4.jar:. RetryBug\nMar 9, 2011 1:09:42 PM RetryBug$1 retryRequest\nINFO: count=1 java.net.SocketTimeoutException: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (java.net.SocketTimeoutException) caught when processing request: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 9, 2011 1:09:42 PM RetryBug$1 retryRequest\nINFO: count=2 java.net.SocketTimeoutException: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (java.net.SocketTimeoutException) caught when processing request: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 9, 2011 1:09:42 PM RetryBug$1 retryRequest\nINFO: count=3 java.net.SocketTimeoutException: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (java.net.SocketTimeoutException) caught when processing request: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 9, 2011 1:09:42 PM RetryBug$1 retryRequest\nINFO: count=4 java.net.SocketTimeoutException: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: I/O exception (java.net.SocketTimeoutException) caught when processing request: Read timed out\nMar 9, 2011 1:09:42 PM org.apache.http.impl.client.DefaultRequestDirector tryExecute\nINFO: Retrying request\nMar 9, 2011 1:09:51 PM RetryBug$1 retryRequest\nINFO: count=5 java.net.SocketTimeoutException: Read timed out\nException in thread \"main\" java.net.SocketTimeoutException: Read timed out\n        at java.net.SocketInputStream.socketRead0(Native Method)\n        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n        at org.apache.http.impl.io.AbstractSessionInputBuffer.fillBuffer(AbstractSessionInputBuffer.java:149)\n        at org.apache.http.impl.io.SocketInputBuffer.fillBuffer(SocketInputBuffer.java:110)\n        at org.apache.http.impl.io.AbstractSessionInputBuffer.readLine(AbstractSessionInputBuffer.java:260)\n        at org.apache.http.impl.conn.DefaultResponseParser.parseHead(DefaultResponseParser.java:98)\n        at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:252)\n        at org.apache.http.impl.AbstractHttpClientConnection.receiveResponseHeader(AbstractHttpClientConnection.java:281)\n        at org.apache.http.impl.conn.DefaultClientConnection.receiveResponseHeader(DefaultClientConnection.java:247)\n        at org.apache.http.impl.conn.AbstractClientConnAdapter.receiveResponseHeader(AbstractClientConnAdapter.java:219)\n        at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:298)\n        at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:125)\n        at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:622)\n        at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:454)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:820)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:754)\n        at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:732)\n        at RetryBug.main(RetryBug.java:27)\n$",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "HTTPCLIENT-1069",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Minor",
    "product": "HTTPCLIENT",
    "project": "HTTPCLIENT",
    "summary": "HttpClient 4.1 ignores request retry handler and stops retrying when a read timeout is followed by a connection refusal",
    "systemSpecification": true,
    "version": "4.1 Final"
}