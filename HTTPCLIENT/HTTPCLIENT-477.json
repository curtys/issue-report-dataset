{
    "comments": [
        {
            "author": "Oleg Kalnichevski",
            "body": "Will require a new parameter and is likely to require more changes in the auth\ncode than I would be comfortable with so late in the release process. Pushed\nback to 3.1\n\nOleg",
            "date": "2005-08-22T22:12:55.000+0000",
            "id": 0
        },
        {
            "author": "Oleg Kalnichevski",
            "body": "I do not see a way to fix the problem cleanly in 3.1. I suggest we deal with it in 4.0 \n\nOleg",
            "date": "2006-05-31T04:04:59.000+0000",
            "id": 1
        },
        {
            "author": "Oleg Kalnichevski",
            "body": "Httpclient 4.0 now uses distinct instances of the authentication handler interface to authenticate against target and proxy hosts. This allows for injection of a custom handler responsible for authentication with just one type of hosts.\n\nOleg",
            "date": "2007-10-18T14:48:34.198+0000",
            "id": 2
        }
    ],
    "component": "HttpClient (classic)",
    "description": "Using HttpClient 3.0 rc2, you cannot authenticate to a site using Basic\nAutentication and to a proxy server using NTLM authentication.\n\nWhen you indicate a prefference to use NTLM over Basic authentication the\nauthentication will fail when it tries to authenticate NTML to the Proxy and to\nthe Site. If you indicate Basic, then NTLM authentication order the Basic\nauthentication will fail when used for the Proxy (since basic authentication\ncan't send the domain name it fails).\n\nThe email thread from the discussion group is pasted below for refference.\n\n==============================================================\n==============================================================\n\nHi all,\nI am trying to authenticate to a server via a proxy which also requires\nauthentication. It seems that I can get either the proxy authentication to work\nOR the site authentication to work, but not both.\n\nBoth seem to work independently when I set the credentials (or proxy\ncredentials) using NTCredentials (e.g. if I connect to the site from a network\nnot using a proxy I can get it to work, and I can authenticate to the proxy only\nto get a 401 authentication failed from the server when using the proxy).\n\nI read in the Authentication tutorial that you can't authenticate using NTLM to\nboth the proxy and site, so I'm trying various combinations of authentication,\nbut I can't find any documentation that specifically covers this case and I feel\nlike I'm just taking stabs in the dark right now.\n\nIf anyone can point me in the direction of the light at the end of the tunnel\nI'd really appreciate it.\n\nThanks,\nDavid\n\n----------------\n\nOn Wed, Jun 29, 2005 at 09:53:07AM -0700, David Parks wrote:\n> Hi all,\n> I am trying to authenticate to a server via a proxy which also requires\nauthentication. It seems that I can get either the proxy authentication to work\nOR the site authentication to work, but not both.\n> \n> Both seem to work independently when I set the credentials (or proxy\ncredentials) using NTCredentials (e.g. if I connect to the site from a network\nnot using a proxy I can get it to work, and I can authenticate to the proxy only\nto get a 401 authentication failed from the server when using the proxy).\n> \n> I read in the Authentication tutorial that you can't authenticate using NTLM\nto both the proxy and site, so I'm trying various combinations of\nauthentication, but I can't find any documentation that specifically covers this\ncase and I feel like I'm just taking stabs in the dark right now.\n\nDavid,\n\nYou _really_ can't use NTLM to authenticate with the proxy and the\ntarget host at the same, due to the nature of this authentication\nscheme. Really. That was not a joke.\n\nPlease consider using one of the following combinations instead:\n\n(1) BASIC proxy + NTLM host if both the clent and the proxy are within a\ntrusted network segment\n\n(2) NTLM proxy + SSL + BASIC host\n\nBoth combinations should provide an adequate (or better in the latter case)\nsecurity\n\nHope this helps\n\nOleg\n\n> \n> If anyone can point me in the direction of the light at the end of the tunnel\nI'd really appreciate it.\n> \n> Thanks,\n> David\n> \n> \n\n-------------------\n\nThanks for the reply Oleg. This is what I figured, but I cannot see how to use\ndifferent authentication schemes for the Proxy vs. the Site authentication\nchallenge.\n\nI tried adding the code suggested in the Authentication tutorial:\n\n        List authPrefs = new ArrayList(2);\n        authPrefs.add(AuthPolicy.DIGEST);\n        authPrefs.add(AuthPolicy.BASIC);\n        authPrefs.add(AuthPolicy.NTLM);\n         This will exclude the NTLM authentication scheme\n        httpclient.getParams().setParameter(AuthPolicy.AUTH_SCHEME_PRIORITY,\nauthPrefs);\n\nI got a message stating that it was attempting BASIC authentication for the\nProxy and that it failed (probably because the domain doesn't get passed I\nguess). So my thought is that I need NTLM for the proxy authentication and Basic\nwill work for the site authentication.\n\nThe question I am then working on is how to direct the HttpClient to select that\norder of authentication methods. If I let it take NTLM as the preffered\nauthentication method then it will try to authenticate both challenges with NTLM.\n\nI sure there is just some little detail I'm missing here somewhere, it's just\nhard to find it.\n\nThanks a lot!\nDavid\n\n------------------\n\nDavid,\n\nI see the problem. This will require a patch and a new parameter.\nLuckily the preference API introduced in HttpClient 3.0 allows up to add\nparameters quite easily. Please file a feature request with Bugzilla\nASAP and I'll do my best to hack up a patch before I leave for holidays\n(that is Friday, July 1st)\n\nOleg\n\n\n--------------\n\nHi Oleg, thanks, I'll put that request in today.\nThis helps a lot, at least I know I'm on the right path now.\n\nI am attempting to devise a workaround for this by handling the authentication\nmanually (setDoAuthentication(false)).\n\nWhen I see a 401 error I am processing a basic authentication with the site\ncredentials, when I see a 407 error I want to process an NTLM authentication\nwith the proxy credentials.\n\nTo that end I have the following code that runs after\nhttpclient.execute(getmethod) executes. The code below works perfectly for the\nbasic authentication (when the proxy is not in the picture).\n\nIn looking up the Handshake of the NTLM authentication I see that I have a\nproblem with the code below since the handshake includes 2 challenge and\nauthorization steps before the authentication succeeds. I'm not clear how I\ncould manually authenticate the NTLM response. I would expect the NTLMScheme\nclass to contain a Type 1 and Type 3 authenticate() method for processing both\nchallenge responses. Is there another way of processing the NTLM authentication\nafter receiving the initial authentication challenge from the server?\n\n        //Check for Proxy or Site authentication\n        if(getmethod.getStatusCode() == 401){\n            //Authenticate to the site using Basic authentication.\n            BasicScheme basicscheme = new BasicScheme();\n            String basic_auth_string = basicscheme.authenticate(new\nNTCredentials(\"cwftp\", \"664A754c\", \"\", \"\"), getmethod);\n            Header basic_auth_header = new Header(\"Authorization\",\nbasic_auth_string);\n            getmethod.addRequestHeader(basic_auth_header);\n            try{\n                httpclient.executeMethod(getmethod);\n            }catch(Exception e){\n                logger.log(Level.SEVERE, \"ack!!!!\", e);\n            }\n            return getmethod;\n       }else if(getmethod.getStatusCode() == 407){\n            //Authenticate to the site using Basic authentication\n            NTLMScheme ntlmscheme = new NTLMScheme();\n            String basic_auth_string = ntlmscheme.authenticate(new\nNTCredentials(\"00mercbac\", \"!@SAMmerc2004\", \"simproxy\", \"CFC\"), getmethod);\n            Header basic_auth_header = new Header(\"Authorization\",\nbasic_auth_string);\n            getmethod.addRequestHeader(basic_auth_header);\n            try{\n                httpclient.executeMethod(getmethod);\n            }catch(Exception e){\n                logger.log(Level.SEVERE, \"ack!!!!\", e);\n            }\n            return getmethod;\n       }\n\n\nThanks,\nDavid",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "HTTPCLIENT-477",
    "issuetypeClassified": "RFE",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "HTTPCLIENT",
    "project": "HTTPCLIENT",
    "summary": "There is no way to specify a different auth scheme priority for host and proxy",
    "systemSpecification": true,
    "version": "3.0 Beta 1"
}