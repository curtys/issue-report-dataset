{
    "comments": [
        {
            "author": "Simon Willnauer",
            "body": "I will dig!",
            "date": "2011-06-10T20:02:12.687+0000",
            "id": 0
        },
        {
            "author": "Simon Willnauer",
            "body": "{noformat}\n    [junit] Testcase: testRandom(org.apache.lucene.index.TestStressIndexing2):\tFAILED\n    [junit] Some threads threw uncaught exceptions!\n    [junit] junit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1403)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1321)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:603)\n    [junit] \n    [junit] \n    [junit] Tests run: 3, Failures: 2, Errors: 0, Time elapsed: 9.243 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] java.lang.AssertionError: ram was 462219 expected: 409920 flush mem: 396467 active: 65752\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushControl.assertMemory(DocumentsWriterFlushControl.java:102)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushControl.doAfterDocument(DocumentsWriterFlushControl.java:164)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:380)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1474)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1446)\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2$IndexingThread.indexDoc(TestStressIndexing2.java:723)\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2$IndexingThread.run(TestStressIndexing2.java:757)\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressIndexing2 -Dtestmethod=testRandom -Dtests.seed=-3081198538389112044:6990165845273194870 -Dtests.multiplier=3\n{noformat}\n\njenkins just tripped a similar issue... the problem here seems related to a very lowish rambuffer together\nwith flushing by docCount. I was not able to reproduce it yet.\neach time this fails ram buffer is 0.1M and maxBufferedDocs is 3 so\nsomething seems to break the assert if we flush by doccount and not\nnecessarily take the largest DWPT out of the loop\n\nselckin can you reproduce these errors? I just added some more info to the assert so if you run into it can you past the output?",
            "date": "2011-06-14T10:05:52.644+0000",
            "id": 1
        },
        {
            "author": "selckin",
            "body": "{code}\n\n    [junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\n    [junit] Tests run: 50, Failures: 2, Errors: 0, Time elapsed: 11.135 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] java.lang.AssertionError: ram was 460248 expected: 407592 flush mem: 394568 active: 65680 pending: 0 flushing: 3 blocked: 0 peakDelta: 65959\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushControl.assertMemory(DocumentsWriterFlushControl.java:102)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushControl.doAfterDocument(DocumentsWriterFlushControl.java:164)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:380)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1474)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1446)\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2$IndexingThread.indexDoc(TestStressIndexing2.java:723)\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2$IndexingThread.run(TestStressIndexing2.java:757)\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressIndexing2 -Dtestmethod=testMultiConfig -Dtests.seed=2571834029692482827:-8116419692655152763\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressIndexing2 -Dtestmethod=testMultiConfig -Dtests.seed=2571834029692482827:-8116419692655152763\n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Thread-793 ***\n    [junit] junit.framework.AssertionFailedError: java.lang.AssertionError: ram was 460248 expected: 407592 flush mem: 394568 active: 65680 pending: 0 flushing: 3 blocked: 0 peakDelta: 65959\n    [junit] \tat junit.framework.Assert.fail(Assert.java:47)\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2$IndexingThread.run(TestStressIndexing2.java:762)\n    [junit] NOTE: test params are: codec=RandomCodecProvider: {f34=MockRandom, f33=Standard, f32=Standard, f31=MockSep, f30=Pulsing(freqCutoff=7), f39=Standard, f38=MockSep, f37=Pulsing(freqCutoff=7), f36=MockFixedIntBlock(blockSize=649), f35=MockVariableIntBlock(baseBlockSize=9), f43=MockFixedIntBlock(blockSize=649), f42=MockVariableIntBlock(baseBlockSize=9), f45=MockSep, f44=Pulsing(freqCutoff=7), f41=MockRandom, f40=Standard, f47=Standard, f46=Standard, f49=MockVariableIntBlock(baseBlockSize=9), f48=MockRandom, f6=Pulsing(freqCutoff=7), f7=MockSep, f8=Standard, f9=MockVariableIntBlock(baseBlockSize=9), f12=Standard, f11=Standard, f10=MockSep, f16=Pulsing(freqCutoff=7), f15=MockFixedIntBlock(blockSize=649), f14=MockVariableIntBlock(baseBlockSize=9), f13=MockRandom, f19=Standard, f18=Standard, f17=MockSep, f1=MockFixedIntBlock(blockSize=649), f0=MockVariableIntBlock(baseBlockSize=9), f3=MockSep, f2=Pulsing(freqCutoff=7), f5=MockVariableIntBlock(baseBlockSize=9), f4=Standard, f21=MockVariableIntBlock(baseBlockSize=9), f20=MockRandom, f23=Pulsing(freqCutoff=7), f22=MockFixedIntBlock(blockSize=649), f25=Standard, f24=MockSep, f27=MockRandom, f26=Standard, f29=MockFixedIntBlock(blockSize=649), f28=MockVariableIntBlock(baseBlockSize=9), f98=MockVariableIntBlock(baseBlockSize=9), f97=MockRandom, f99=MockFixedIntBlock(blockSize=649), f94=MockSep, f93=Pulsing(freqCutoff=7), f96=Standard, f95=Standard, f79=Pulsing(freqCutoff=7), f77=MockVariableIntBlock(baseBlockSize=9), f78=MockFixedIntBlock(blockSize=649), f75=Standard, f76=MockRandom, f73=MockSep, f74=Standard, f71=MockFixedIntBlock(blockSize=649), f72=Pulsing(freqCutoff=7), f81=MockVariableIntBlock(baseBlockSize=9), f80=MockRandom, f86=Pulsing(freqCutoff=7), f87=MockSep, f88=Standard, f89=Standard, f82=Standard, f83=MockRandom, f84=MockVariableIntBlock(baseBlockSize=9), f85=MockFixedIntBlock(blockSize=649), f90=Pulsing(freqCutoff=7), f92=Standard, f91=MockSep, f59=MockSep, f57=MockFixedIntBlock(blockSize=649), f58=Pulsing(freqCutoff=7), f51=Pulsing(freqCutoff=7), f52=MockSep, f50=MockFixedIntBlock(blockSize=649), f55=MockRandom, f56=MockVariableIntBlock(baseBlockSize=9), f53=Standard, f54=Standard, id=MockFixedIntBlock(blockSize=649), f68=Standard, f69=MockRandom, f60=Standard, f61=Standard, f62=MockRandom, f63=MockVariableIntBlock(baseBlockSize=9), f64=MockFixedIntBlock(blockSize=649), f65=Pulsing(freqCutoff=7), f66=MockSep, f67=Standard, f70=MockSep}, locale=en_SG, timezone=Europe/Dublin\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressIndexing2]\n    [junit] NOTE: Linux 2.6.39-gentoo amd64/Sun Microsystems Inc. 1.6.0_26 (64-bit)/cpus=8,threads=1,free=61143744,total=147718144\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: testMultiConfig(org.apache.lucene.index.TestStressIndexing2):\tFAILED\n    [junit] r1.numDocs()=19 vs r2.numDocs()=18\n    [junit] junit.framework.AssertionFailedError: r1.numDocs()=19 vs r2.numDocs()=18\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:308)\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:278)\n    [junit] \tat org.apache.lucene.index.TestStressIndexing2.testMultiConfig(TestStressIndexing2.java:124)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1403)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1321)\n    [junit] \n    [junit] \n    [junit] Testcase: testMultiConfig(org.apache.lucene.index.TestStressIndexing2):\tFAILED\n    [junit] Some threads threw uncaught exceptions!\n    [junit] junit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:603)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1403)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1321)\n    [junit] \n    [junit] \n    [junit] Test org.apache.lucene.index.TestStressIndexing2 FAILED\n{code}",
            "date": "2011-06-14T10:10:57.901+0000",
            "id": 2
        },
        {
            "author": "Simon Willnauer",
            "body": "I managed to reproduce this and trip into it with a debugger. So what happens here is bizarre :)\nDue to the very tight maxBufferedDocs (3) and maxRamBufferSizeMB (0.1MB) we have a pretty good chance that several in flight DWPT will trigger a flush after the document they are indexing right now. That means that if we have lets say 4 DWPT and 3 are already flushing and memory is close to the asserts limit we got a problem if there is already a 4th DWPT in flight (passed the stall check) the document can easily add enough bytes that we cross the asserts max expected ram and fail then. \n\nI am not sure how we can fix that right now but at least its not a bug in DWPT.",
            "date": "2011-06-14T14:34:29.783+0000",
            "id": 3
        },
        {
            "author": "Simon Willnauer",
            "body": "here is a patch that prevent this assert when ram buffer is low compared to the size of the documents we are indexing.\n\nfor \"normal\" setting the assert will be executed but for very lowish documents we simply skip it entirely",
            "date": "2011-06-14T22:20:19.683+0000",
            "id": 4
        },
        {
            "author": "Simon Willnauer",
            "body": "fixed in rev 1136086",
            "date": "2011-06-15T15:39:33.868+0000",
            "id": 5
        }
    ],
    "component": "",
    "description": "trunk: r1134311\n\nreproducible\n\n{code}\n    [junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\n    [junit] Tests run: 1, Failures: 2, Errors: 0, Time elapsed: 0.882 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] java.lang.AssertionError: ram was 460908 expected: 408216 flush mem: 395100 active: 65808\n    [junit]     at org.apache.lucene.index.DocumentsWriterFlushControl.assertMemory(DocumentsWriterFlushControl.java:102)\n    [junit]     at org.apache.lucene.index.DocumentsWriterFlushControl.doAfterDocument(DocumentsWriterFlushControl.java:164)\n    [junit]     at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:380)\n    [junit]     at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1473)\n    [junit]     at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1445)\n    [junit]     at org.apache.lucene.index.TestStressIndexing2$IndexingThread.indexDoc(TestStressIndexing2.java:723)\n    [junit]     at org.apache.lucene.index.TestStressIndexing2$IndexingThread.run(TestStressIndexing2.java:757)\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressIndexing2 -Dtestmethod=testMultiConfig -Dtests.seed=2571834029692482827:-8116419692655152763\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressIndexing2 -Dtestmethod=testMultiConfig -Dtests.seed=2571834029692482827:-8116419692655152763\n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Thread-0 ***\n    [junit] junit.framework.AssertionFailedError: java.lang.AssertionError: ram was 460908 expected: 408216 flush mem: 395100 active: 65808\n    [junit]     at junit.framework.Assert.fail(Assert.java:47)\n    [junit]     at org.apache.lucene.index.TestStressIndexing2$IndexingThread.run(TestStressIndexing2.java:762)\n    [junit] NOTE: test params are: codec=RandomCodecProvider: {f33=Standard, f57=MockFixedIntBlock(blockSize=649), f11=Standard, f41=MockRandom, f40=Standard, f62=MockRandom, f75=Standard, f73=MockSep, f29=MockFixedIntBlock(blockSize=649), f83=MockRandom, f66=MockSep, f49=MockVariableIntBlock(baseBlockSize=9), f72=Pulsing(freqCutoff=7), f54=Standard, id=MockFixedIntBlock(blockSize=649), f80=MockRandom, f94=MockSep, f93=Pulsing(freqCutoff=7), f95=Standard}, locale=en_SG, timezone=Pacific/Palau\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressIndexing2]\n    [junit] NOTE: Linux 2.6.39-gentoo amd64/Sun Microsystems Inc. 1.6.0_25 (64-bit)/cpus=8,threads=1,free=133324528,total=158400512\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: testMultiConfig(org.apache.lucene.index.TestStressIndexing2):     FAILED\n    [junit] r1.numDocs()=17 vs r2.numDocs()=16\n    [junit] junit.framework.AssertionFailedError: r1.numDocs()=17 vs r2.numDocs()=16\n    [junit]     at org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:308)\n    [junit]     at org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:278)\n    [junit]     at org.apache.lucene.index.TestStressIndexing2.testMultiConfig(TestStressIndexing2.java:124)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1403)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1321)\n    [junit] \n    [junit] \n    [junit] Testcase: testMultiConfig(org.apache.lucene.index.TestStressIndexing2):     FAILED\n    [junit] Some threads threw uncaught exceptions!\n    [junit] junit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\n    [junit]     at org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:603)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1403)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1321)\n    [junit] \n    [junit] \n    [junit] Test org.apache.lucene.index.TestStressIndexing2 FAILED\n{code}",
    "hasPatch": true,
    "hasScreenshot": false,
    "id": "LUCENE-3190",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "LUCENE",
    "project": "LUCENE",
    "summary": "TestStressIndexing2 testMultiConfig failure",
    "systemSpecification": true,
    "version": ""
}