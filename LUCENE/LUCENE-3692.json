{
    "comments": [
        {
            "author": "Simon Willnauer",
            "body": "s/rum/RAM :)",
            "date": "2012-01-12T18:10:41.883+0000",
            "id": 0
        },
        {
            "author": "Simon Willnauer",
            "body": "here is a patch that makes pruning the ticket queue non-blocking ie. we don't hold the lock that is used to append to the queue when we try to publish the head of the queue but at the same time prevent other threads from peeking at the head and publish. I extracted all that logic into a new more readable class and cleaned up DW. \n\nI also added lots of new asserts in that queue - all tests pass over 300 iterations even the famous TestRealtimeGet :)",
            "date": "2012-01-12T18:16:11.778+0000",
            "id": 1
        },
        {
            "author": "Simon Willnauer",
            "body": "I'm going to commit this soon if nobody objects",
            "date": "2012-01-16T12:05:03.791+0000",
            "id": 2
        }
    ],
    "component": "core/index",
    "description": "In DocumentsWriter we have a safety check that applies all deletes if the deletes consume too much RAM to prevent too-frequent flushing of a long tail of tiny segments. If we enter applyAllDeletes we essentially lock on IW -> BufferedDeletes which is fine since this usually doesn't take long and doesn't keep DWPTs from indexing. Yet, if that takes long and at the same time a semgent is flushed and subsequently published to the IW we take the lock on the ticket queue and the IW. Now this prevents all other threads to append to the ticketQueue which is done BEFORE we actually flush the segment concurrently and free up the RAM.\n\nEssentially its ok to block on the IW lock but we should not keep concurrent flushed from execution just because we apply deletes. The threads will block once they try to execute maybeMerge after the segment is flushed so we don't pile up subsequent memory but we should actually allow the DWPT to be flushed since we actually try to get rid of memory.\n\nI ran into this by accident due to a coding bug using delete queries instead of terms for each document. This thread dump show the problem:\n\n{noformat}\n\"Application Worker Thread\" prio=10 tid=0x00007fdda0238000 nid=0x3256 waiting for\nmonitor entry [0x00007fddad3c2000]\n  java.lang.Thread.State: BLOCKED (on object monitor)\n       at org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:424)\n       - waiting to lock <0x00007fddb74ff990> (a\norg.apache.lucene.index.DocumentsWriter$TicketQueue)\n       at org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:320)\n       at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:393)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1484)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n\n\"Application Worker Thread\" prio=10 tid=0x00007fdda0236000 nid=0x3255 waiting for\nmonitor entry [0x00007fddad4c3000]\n  java.lang.Thread.State: BLOCKED (on object monitor)\n       at org.apache.lucene.index.IndexWriter.updatePendingMerges(IndexWriter.java:1854)\n       - waiting to lock <0x00007fddb74fe350> (a\norg.apache.solr.update.SolrIndexWriter)\n       at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1848)\n       at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1843)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1493)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n\n\"Application Worker Thread\" prio=10 tid=0x00007fdda0234000 nid=0x3254 waiting for\nmonitor entry [0x00007fddad5c4000]\n  java.lang.Thread.State: BLOCKED (on object monitor)\n       at org.apache.lucene.index.IndexWriter.updatePendingMerges(IndexWriter.java:1854)\n       - waiting to lock <0x00007fddb74fe350> (a\norg.apache.solr.update.SolrIndexWriter)\n       at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1848)\n       at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1843)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1493)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n\n\"Application Worker Thread\" prio=10 tid=0x00007fdda0232000 nid=0x3253 waiting for\nmonitor entry [0x00007fddad6c5000]\n  java.lang.Thread.State: BLOCKED (on object monitor)\n       at org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:424)\n       - waiting to lock <0x00007fddb74ff990> (a\norg.apache.lucene.index.DocumentsWriter$TicketQueue)\n       at org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:320)\n       at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:393)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1484)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n\n\"Application Worker Thread\" prio=10 tid=0x00007fdda0230800 nid=0x3252 waiting for\nmonitor entry [0x00007fddad7c6000]\n  java.lang.Thread.State: BLOCKED (on object monitor)\n       at org.apache.lucene.index.IndexWriter.updatePendingMerges(IndexWriter.java:1854)\n       - waiting to lock <0x00007fddb74fe350> (a\norg.apache.solr.update.SolrIndexWriter)\n       at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1848)\n       at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1843)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1493)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n\n\"Application Worker Thread\" prio=10 tid=0x00007fdda022e800 nid=0x3251 runnable\n[0x00007fddad8c6000]\n  java.lang.Thread.State: RUNNABLE\n       at java.nio.Bits.copyToArray(Bits.java:715)\n       at java.nio.DirectByteBuffer.get(DirectByteBuffer.java:233)\n       at org.apache.lucene.store.MMapDirectory$MMapIndexInput.readBytes(MMapDirectory.java:319)\n       at org.apache.lucene.index.codecs.BlockTreeTermsReader$FieldReader$SegmentTermsEnum$Frame.loadBlock(BlockTreeTermsReader.java:2283)\n       at org.apache.lucene.index.codecs.BlockTreeTermsReader$FieldReader$SegmentTermsEnum.seekExact(BlockTreeTermsReader.java:1600)\n       at org.apache.lucene.util.TermContext.build(TermContext.java:97)\n       at org.apache.lucene.search.TermQuery.createWeight(TermQuery.java:180)\n       at org.apache.lucene.search.BooleanQuery$BooleanWeight.<init>(BooleanQuery.java:186)\n       at org.apache.lucene.search.BooleanQuery.createWeight(BooleanQuery.java:423)\n       at org.apache.lucene.search.IndexSearcher.createNormalizedWeight(IndexSearcher.java:583)\n       at org.apache.lucene.search.QueryWrapperFilter.getDocIdSet(QueryWrapperFilter.java:55)\n       at org.apache.lucene.index.BufferedDeletesStream.applyQueryDeletes(BufferedDeletesStream.java:431)\n       at org.apache.lucene.index.BufferedDeletesStream.applyDeletes(BufferedDeletesStream.java:268)\n       - locked <0x00007fddb751e1e8> (a\norg.apache.lucene.index.BufferedDeletesStream)\n       at org.apache.lucene.index.IndexWriter.applyAllDeletes(IndexWriter.java:2852)\n       - locked <0x00007fddb74fe350> (a org.apache.solr.update.SolrIndexWriter)\n       at org.apache.lucene.index.DocumentsWriter.applyAllDeletes(DocumentsWriter.java:188)\n       at org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:470)\n       at org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:320)\n       at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:393)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1484)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n       \n\n\"Application Worker Thread\" prio=10 tid=0x00007fdda022d800 nid=0x3250 waiting for\nmonitor entry [0x00007fddad9c8000]\n  java.lang.Thread.State: BLOCKED (on object monitor)\n       at org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:424)\n       - waiting to lock <0x00007fddb74ff990> (a\norg.apache.lucene.index.DocumentsWriter$TicketQueue)\n       at org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:320)\n       at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:393)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1484)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n   \n\"Application Worker Thread\" prio=10 tid=0x00007fdda022d000 nid=0x324f waiting for\nmonitor entry [0x00007fddadac9000]\n  java.lang.Thread.State: BLOCKED (on object monitor)\n       at org.apache.lucene.index.IndexWriter.useCompoundFile(IndexWriter.java:2274)\n       - waiting to lock <0x00007fddb74fe350> (a\norg.apache.solr.update.SolrIndexWriter)\n       at org.apache.lucene.index.IndexWriter.prepareFlushedSegment(IndexWriter.java:2156)\n       at org.apache.lucene.index.DocumentsWriter.publishFlushedSegment(DocumentsWriter.java:526)\n       at org.apache.lucene.index.DocumentsWriter.finishFlush(DocumentsWriter.java:506)\n       at org.apache.lucene.index.DocumentsWriter.applyFlushTickets(DocumentsWriter.java:483)\n       - locked <0x00007fddb74ff990> (a\norg.apache.lucene.index.DocumentsWriter$TicketQueue)\n       at org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:449)\n       at org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:320)\n       at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:393)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1484)\n       at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1456)\n       at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n\n{noformat}",
    "hasPatch": true,
    "hasScreenshot": false,
    "id": "LUCENE-3692",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "LUCENE",
    "project": "LUCENE",
    "summary": "DocumentsWriter blocks flushes when applyDeletes takes forever - memory not released",
    "systemSpecification": true,
    "version": "4.0-ALPHA"
}