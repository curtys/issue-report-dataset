{
    "comments": [
        {
            "author": "Simon Willnauer",
            "body": "here is a patch. Stupid mistake I wonder why this didn't happen earlier. Here is a fix including some asserts that should catch stuff like this immediately.\n\nI will commit shortly",
            "date": "2012-01-19T08:46:22.417+0000",
            "id": 0
        },
        {
            "author": "Robert Muir",
            "body": "Thanks Simon!",
            "date": "2012-01-19T14:42:02.935+0000",
            "id": 1
        }
    ],
    "component": "core/index",
    "description": "    [junit] 2012-01-18 18:18:16\n    [junit] Full thread dump Java HotSpot(TM) 64-Bit Server VM (19.1-b02 mixed mode):\n    [junit] \n    [junit] \"Indexer 3\" prio=10 tid=0x0000000041b9b800 nid=0x6291 waiting for monitor entry [0x00007f7e8868f000]\n    [junit]    java.lang.Thread.State: BLOCKED (on object monitor)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.innerPurge(DocumentsWriterFlushQueue.java:118)\n    [junit] \t- waiting to lock <0x00000000e40ff2a8> (a org.apache.lucene.index.DocumentsWriterFlushQueue)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.tryPurge(DocumentsWriterFlushQueue.java:141)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:439)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:317)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:390)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1534)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1506)\n    [junit] \tat org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread.run(TestIndexWriterExceptions.java:187)\n    [junit] \n    [junit] \"Indexer 2\" prio=10 tid=0x0000000041b9b000 nid=0x6290 waiting on condition [0x00007f7e8838c000]\n    [junit]    java.lang.Thread.State: WAITING (parking)\n    [junit] \tat sun.misc.Unsafe.park(Native Method)\n    [junit] \t- parking to wait for  <0x00000000e4103100> (a org.apache.lucene.index.DocumentsWriterStallControl$Sync)\n    [junit] \tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireShared(AbstractQueuedSynchronizer.java:941)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireShared(AbstractQueuedSynchronizer.java:1261)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterStallControl.waitIfStalled(DocumentsWriterStallControl.java:115)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushControl.waitIfStalled(DocumentsWriterFlushControl.java:591)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.preUpdate(DocumentsWriter.java:302)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:362)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1534)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1506)\n    [junit] \tat org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread.run(TestIndexWriterExceptions.java:187)\n    [junit] \n    [junit] \"Indexer 1\" prio=10 tid=0x0000000042500000 nid=0x628f waiting for monitor entry [0x00007f7e8858e000]\n    [junit]    java.lang.Thread.State: BLOCKED (on object monitor)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.addSegment(DocumentsWriterFlushQueue.java:84)\n    [junit] \t- waiting to lock <0x00000000e40ff2a8> (a org.apache.lucene.index.DocumentsWriterFlushQueue)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:424)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:317)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:390)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1534)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1506)\n    [junit] \tat org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread.run(TestIndexWriterExceptions.java:187)\n    [junit] \n    [junit] \"Indexer 0\" prio=10 tid=0x0000000041508000 nid=0x628d waiting on condition [0x00007f7e8848d000]\n    [junit]    java.lang.Thread.State: WAITING (parking)\n    [junit] \tat sun.misc.Unsafe.park(Native Method)\n    [junit] \t- parking to wait for  <0x00000000e414b408> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)\n    [junit] \tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:842)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1178)\n    [junit] \tat java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:186)\n    [junit] \tat java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:262)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.forcePurge(DocumentsWriterFlushQueue.java:130)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.addDeletesAndPurge(DocumentsWriterFlushQueue.java:50)\n    [junit] \t- locked <0x00000000e40ff2a8> (a org.apache.lucene.index.DocumentsWriterFlushQueue)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.applyAllDeletes(DocumentsWriter.java:179)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:460)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:317)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:390)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1534)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1506)\n    [junit] \tat org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread.run(TestIndexWriterExceptions.java:187)\n    [junit] \n    [junit] \"Low Memory Detector\" daemon prio=10 tid=0x00007f7e84025800 nid=0x6003 runnable [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"CompilerThread1\" daemon prio=10 tid=0x00007f7e84022800 nid=0x6002 waiting on condition [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"CompilerThread0\" daemon prio=10 tid=0x00007f7e8401f800 nid=0x6001 waiting on condition [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"Signal Dispatcher\" daemon prio=10 tid=0x00007f7e8401d800 nid=0x6000 waiting on condition [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"Finalizer\" daemon prio=10 tid=0x00007f7e84001000 nid=0x5ffa in Object.wait() [0x00007f7e8961b000]\n    [junit]    java.lang.Thread.State: WAITING (on object monitor)\n    [junit] \tat java.lang.Object.wait(Native Method)\n    [junit] \t- waiting on <0x00000000e2ece380> (a java.lang.ref.ReferenceQueue$Lock)\n    [junit] \tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)\n    [junit] \t- locked <0x00000000e2ece380> (a java.lang.ref.ReferenceQueue$Lock)\n    [junit] \tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)\n    [junit] \tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\n    [junit] \n    [junit] \"Reference Handler\" daemon prio=10 tid=0x000000004101e000 nid=0x5ff9 in Object.wait() [0x00007f7e8971c000]\n    [junit]    java.lang.Thread.State: WAITING (on object monitor)\n    [junit] \tat java.lang.Object.wait(Native Method)\n    [junit] \t- waiting on <0x00000000e2ece318> (a java.lang.ref.Reference$Lock)\n    [junit] \tat java.lang.Object.wait(Object.java:485)\n    [junit] \tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)\n    [junit] \t- locked <0x00000000e2ece318> (a java.lang.ref.Reference$Lock)\n    [junit] \n    [junit] \"main\" prio=10 tid=0x0000000040fb2000 nid=0x5fe2 in Object.wait() [0x00007f7e8ecc1000]\n    [junit]    java.lang.Thread.State: WAITING (on object monitor)\n    [junit] \tat java.lang.Object.wait(Native Method)\n    [junit] \t- waiting on <0x00000000e4105080> (a org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread)\n    [junit] \tat java.lang.Thread.join(Thread.java:1186)\n    [junit] \t- locked <0x00000000e4105080> (a org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread)\n    [junit] \tat java.lang.Thread.join(Thread.java:1239)\n    [junit] \tat org.apache.lucene.index.TestIndexWriterExceptions.testRandomExceptionsThreads(TestIndexWriterExceptions.java:286)\n    [junit] \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    [junit] \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n    [junit] \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    [junit] \tat java.lang.reflect.Method.invoke(Method.java:597)\n    [junit] \tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)\n    [junit] \tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)\n    [junit] \tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)\n    [junit] \tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)\n    [junit] \tat org.junit.rules.TestWatchman$1.evaluate(TestWatchman.java:48)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$3$1.evaluate(LuceneTestCase.java:528)\n    [junit] \tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)\n    [junit] \tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)\n    [junit] \tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:76)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:165)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)\n    [junit] \tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)\n    [junit] \tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)\n    [junit] \tat org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)\n    [junit] \tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)\n    [junit] \tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)\n    [junit] \tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)\n    [junit] \tat org.junit.runners.ParentRunner.run(ParentRunner.java:236)\n    [junit] \tat junit.framework.JUnit4TestAdapter.run(JUnit4TestAdapter.java:39)\n    [junit] \tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:420)\n    [junit] \tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:911)\n    [junit] \tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:743)\n    [junit] \n    [junit] \"VM Thread\" prio=10 tid=0x0000000041017800 nid=0x5fef runnable \n    [junit] \n    [junit] \"GC task thread#0 (ParallelGC)\" prio=10 tid=0x0000000040fc5000 nid=0x5fe3 runnable \n    [junit] \n    [junit] \"GC task thread#1 (ParallelGC)\" prio=10 tid=0x0000000040fc7000 nid=0x5fe4 runnable \n    [junit] \n    [junit] \"GC task thread#2 (ParallelGC)\" prio=10 tid=0x0000000040fc9000 nid=0x5fe5 runnable \n    [junit] \n    [junit] \"GC task thread#3 (ParallelGC)\" prio=10 tid=0x0000000040fca800 nid=0x5fe6 runnable \n    [junit] \n    [junit] \"GC task thread#4 (ParallelGC)\" prio=10 tid=0x0000000040fcc800 nid=0x5fe7 runnable \n    [junit] \n    [junit] \"GC task thread#5 (ParallelGC)\" prio=10 tid=0x0000000040fce800 nid=0x5fe8 runnable \n    [junit] \n    [junit] \"GC task thread#6 (ParallelGC)\" prio=10 tid=0x0000000040fd0000 nid=0x5fe9 runnable \n    [junit] \n    [junit] \"GC task thread#7 (ParallelGC)\" prio=10 tid=0x0000000040fd2000 nid=0x5fea runnable \n    [junit] \n    [junit] \"VM Periodic Task Thread\" prio=10 tid=0x00007f7e84030000 nid=0x6004 waiting on condition \n    [junit] \n    [junit] JNI global references: 1578\n    [junit] \n    [junit] \n    [junit] Found one Java-level deadlock:\n    [junit] =============================\n    [junit] \"Indexer 3\":\n    [junit]   waiting to lock monitor 0x0000000041477498 (object 0x00000000e40ff2a8, a org.apache.lucene.index.DocumentsWriterFlushQueue),\n    [junit]   which is held by \"Indexer 0\"\n    [junit] \"Indexer 0\":\n    [junit]   waiting for ownable synchronizer 0x00000000e414b408, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),\n    [junit]   which is held by \"Indexer 3\"\n    [junit] \n    [junit] Java stack information for the threads listed above:\n    [junit] ===================================================\n    [junit] \"Indexer 3\":\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.innerPurge(DocumentsWriterFlushQueue.java:118)\n    [junit] \t- waiting to lock <0x00000000e40ff2a8> (a org.apache.lucene.index.DocumentsWriterFlushQueue)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.tryPurge(DocumentsWriterFlushQueue.java:141)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:439)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:317)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:390)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1534)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1506)\n    [junit] \tat org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread.run(TestIndexWriterExceptions.java:187)\n    [junit] \"Indexer 0\":\n    [junit] \tat sun.misc.Unsafe.park(Native Method)\n    [junit] \t- parking to wait for  <0x00000000e414b408> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)\n    [junit] \tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:842)\n    [junit] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1178)\n    [junit] \tat java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:186)\n    [junit] \tat java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:262)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.forcePurge(DocumentsWriterFlushQueue.java:130)\n    [junit] \tat org.apache.lucene.index.DocumentsWriterFlushQueue.addDeletesAndPurge(DocumentsWriterFlushQueue.java:50)\n    [junit] \t- locked <0x00000000e40ff2a8> (a org.apache.lucene.index.DocumentsWriterFlushQueue)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.applyAllDeletes(DocumentsWriter.java:179)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:460)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:317)\n    [junit] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:390)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1534)\n    [junit] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1506)\n    [junit] \tat org.apache.lucene.index.TestIndexWriterExceptions$IndexerThread.run(TestIndexWriterExceptions.java:187)\n    [junit] \n    [junit] Found 1 deadlock.\n    [junit] \n    [junit] Heap\n    [junit]  PSYoungGen      total 67136K, used 4647K [0x00000000f5560000, 0x00000000fbc60000, 0x0000000100000000)\n    [junit]   eden space 65792K, 5% used [0x00000000f5560000,0x00000000f58a5e10,0x00000000f95a0000)\n    [junit]   from space 1344K, 96% used [0x00000000f9740000,0x00000000f98840a0,0x00000000f9890000)\n    [junit]   to   space 19840K, 0% used [0x00000000fa900000,0x00000000fa900000,0x00000000fbc60000)\n    [junit]  PSOldGen        total 171392K, used 66868K [0x00000000e0000000, 0x00000000ea760000, 0x00000000f5560000)\n    [junit]   object space 171392K, 39% used [0x00000000e0000000,0x00000000e414d080,0x00000000ea760000)\n    [junit]  PSPermGen       total 21248K, used 14733K [0x00000000dae00000, 0x00000000dc2c0000, 0x00000000e0000000)\n    [junit]   object space 21248K, 69% used [0x00000000dae00000,0x00000000dbc635a8,0x00000000dc2c0000)\n    [junit] \n",
    "hasPatch": true,
    "hasScreenshot": false,
    "id": "LUCENE-3705",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "LUCENE",
    "project": "LUCENE",
    "summary": "deadlock in TestIndexWriterExceptions",
    "systemSpecification": true,
    "version": "4.0-ALPHA"
}