{
    "comments": [
        {
            "author": "Julian Reschke",
            "body": "This seems to be caused by\n\n    @Override\n    public int nextDoc() throws IOException {\n        while (currentDoc != NO_MORE_DOCS) {\n            if (scorers[currentScorer].nextDoc() != NO_MORE_DOCS) {\n                currentDoc = scorers[currentScorer].docID() + starts[currentScorer];\n                return currentDoc;\n            } else if (++currentScorer < scorers.length) {\n                // advance to next scorer\n            } else {\n                // no more scorers\n                currentDoc = NO_MORE_DOCS;\n            }\n        }\n\n        return currentDoc;\n    }\n\nwhich allows currentScorer to go beyond scorers.length and\n\n    @Override\n    public float score() throws IOException {\n        return scorers[currentScorer].score();\n    }\n\nwhich assumes it is in-range.\n\nNot sure whether the caller is supposed to call score() when the object is in this state.\n\nChanging it to\n\n    @Override\n    public int nextDoc() throws IOException {\n        while (currentDoc != NO_MORE_DOCS) {\n            if (scorers[currentScorer].nextDoc() != NO_MORE_DOCS) {\n                currentDoc = scorers[currentScorer].docID() + starts[currentScorer];\n                return currentDoc;\n            } else if (currentScorer + 1 < scorers.length) {\n                // advance to next scorer\n               currentScorer += 1;\n            } else {\n                // no more scorers\n                currentDoc = NO_MORE_DOCS;\n            }\n        }\n\n        return currentDoc;\n    }\n\nfixes the runtime exception, but I'm not totally sure about the correctness.",
            "date": "2011-09-22T15:39:34.652+0000",
            "id": 0
        },
        {
            "author": "Julian Reschke",
            "body": "More observations:\n\n- the problem doesn't seem to occur when the test case is run in isolation (but running all tests in the class usually triggers it)\n\n- the behavior of the scorer seems to be per spec; the question is why score() is called when the object is in the \"invalid\" state",
            "date": "2011-09-23T08:25:17.293+0000",
            "id": 1
        },
        {
            "author": "Julian Reschke",
            "body": "This makes it *easier* to reproduce the problem, but it still doesn't occur on every run:\n\n    public void testRepeat() throws NotExecutableException, RepositoryException {\n        for (int i = 0; i < 100; i++)\n            testFindAuthorizableByRelativePath();\n    }\n    \n",
            "date": "2011-09-26T11:37:59.838+0000",
            "id": 2
        },
        {
            "author": "Julian Reschke",
            "body": "Added lots of debug code...:\n\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 constructed from org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery$DescendantSelfAxisScorer@18c5cb7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@89f27f nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@89f27f nextDoc() exit 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@89f27f score() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@89f27f nextDoc() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@89f27f nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f nextDoc() exit 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f score() entry 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f nextDoc() entry 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f nextDoc() exit 1641 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f score() entry 1641 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f nextDoc() entry 1641 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1e09a0f nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 advance() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@a28410 advance() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b2da5 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@51adbe constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@659f5d constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@51adbe nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@51adbe nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@659f5d nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@659f5d nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1c1d37f constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@245893 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1c1d37f nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1c1d37f nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@245893 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@245893 nextDoc() exit 881 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@332954 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e constructed from org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery$DescendantSelfAxisScorer@aa7d00\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b2da5 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b2da5 nextDoc() exit 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b2da5 score() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b2da5 nextDoc() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b2da5 nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@332954 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@332954 nextDoc() exit 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@332954 score() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@332954 nextDoc() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@332954 nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e advance() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@de552e advance() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@f4b252 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e74cf6 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@16dd606 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e74cf6 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e74cf6 nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@16dd606 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@16dd606 nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1fe3302 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1c6d395 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1fe3302 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1fe3302 nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1c6d395 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1c6d395 nextDoc() exit 881 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@6d0e60 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 constructed from org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery$DescendantSelfAxisScorer@98c0fc\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@f4b252 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@f4b252 nextDoc() exit 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@f4b252 score() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@f4b252 nextDoc() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@f4b252 nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@6d0e60 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@6d0e60 nextDoc() exit 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@6d0e60 score() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@6d0e60 nextDoc() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@6d0e60 nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 advance() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1caca13 advance() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e4563a constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@d9048d constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b9d2c0 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@d9048d nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@d9048d nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b9d2c0 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1b9d2c0 nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@bb4a7f constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@17e174 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@bb4a7f nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@bb4a7f nextDoc() exit 880 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@17e174 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@17e174 nextDoc() exit 881 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1d2aa9f constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 constructed 7 8\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1d2aa9f nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1d2aa9f nextDoc() exit 0 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() exit 1630 5\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() exit 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e4563a nextDoc() entry -1 0\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e4563a nextDoc() exit 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e4563a score() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e4563a nextDoc() entry 878 1\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@e4563a nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() entry 1630 5\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() exit 1632 5\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e constructed from org.apache.lucene.search.BooleanScorer2@d6524f\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1d2aa9f score() entry 1632 5\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 score() entry 1632 5\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 score() entry 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() entry 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() exit 1641 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() entry 1632 5\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() exit 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() entry 1641 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() entry 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() exit 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1d2aa9f score() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 score() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 score() entry 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() got IOOBE\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e advance() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e advance() exit\n\nSo what happens is that LuceneQueryHits uses a BooleanScorer which uses *two* instances of MultiScorer.\n\nIt calls nextDoc:\n\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() entry 1641 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 nextDoc() exit 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() entry 1640 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 nextDoc() exit 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e nextDoc() exit\n\nand one of the two MultiScorers says NO_MORE_DOCS.\n\nHowever it then calls score() on both of them:\n\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() entry\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1d2aa9f score() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@1bfd296 score() entry 1642 6\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.MultiScorer@a5eaf4 score() entry 2147483647 7\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() got IOOBE\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e score() exit\nThread[main,5,main] org.apache.jackrabbit.core.query.lucene.LuceneQueryHits$TracingScorer@1a6639e advance() entry\n\nDunno whether that's a Lucene or Jackrabbit problem.\n\nMaking MultiScorer.score() more tolerant would \"fix\" the problem; but that seems like a hack to me.",
            "date": "2011-09-26T12:17:33.020+0000",
            "id": 3
        },
        {
            "author": "Alex Deparvu",
            "body": "It would appear that the DescendantSelfAxisScorer does not respect the DocIdSetIterator API on the advance() method.\n\nThe BooleanScorer2 has 2 scorers: a DescendantSelfAxisScorer and a MultiScorer.\nWhen the MultiScorer is finished, the BooleanScorer2 will call advance on the DescendantSelfAxisScorer with a Integer.MAX_VALUE.\n\nBecause the DescendantSelfAxisScorer does not respect the api, instead of exausting the scorer, it only calls \"subScorer.nextDoc()\" once, thus reverting the current docId, to a smaller value, instead of NO_MORE_DOCS.\nThis propagates through all the embedded scorers, acting like there are more docs in the current query, when in fact there are no more.\n\nI'm attaching a patch for this specific advance(Integer.MAX_VALUE) on the DescendantSelfAxisScorer that apparently fixes the problem.\n\nThe DescendantSelfAxisScorer still does not comply with the api, and it would be interesting to look at the other existing implementations in JR, to check for compliance.\n\nAt the very least we should enable this optimization for the case where it is called with NO_MORE_DOCS, to shortcut to the end of the stream.\n\n\n\n\n\n",
            "date": "2011-10-03T13:57:21.092+0000",
            "id": 4
        },
        {
            "author": "Julian Reschke",
            "body": "The analysis sounds right to me; and I haven't been able to repro the problem so far with the patch applied.",
            "date": "2011-10-04T10:56:20.952+0000",
            "id": 5
        },
        {
            "author": "Alex Deparvu",
            "body": "fixed in revision 1179129.\n\nI've created JCR-3091 to track the scorer 'advance' changes.",
            "date": "2011-10-05T10:02:51.247+0000",
            "id": 6
        }
    ],
    "component": "jackrabbit-core",
    "description": "Stack trace:\n\njava.lang.ArrayIndexOutOfBoundsException: 8\n\tat org.apache.jackrabbit.core.query.lucene.MultiScorer.score(MultiScorer.java:89)\n\tat org.apache.lucene.search.ConjunctionScorer.score(ConjunctionScorer.java:133)\n\tat org.apache.lucene.search.BooleanScorer2$2.score(BooleanScorer2.java:182)\n\tat org.apache.lucene.search.BooleanScorer2.score(BooleanScorer2.java:303)\n\tat org.apache.jackrabbit.core.query.lucene.LuceneQueryHits.nextScoreNode(LuceneQueryHits.java:68)\n\tat org.apache.jackrabbit.core.query.lucene.QueryHitsAdapter.nextScoreNodes(QueryHitsAdapter.java:54)\n\tat org.apache.jackrabbit.core.query.lucene.FilterMultiColumnQueryHits.nextScoreNodes(FilterMultiColumnQueryHits.java:63)\n\tat org.apache.jackrabbit.core.query.lucene.QueryResultImpl.collectScoreNodes(QueryResultImpl.java:328)\n\tat org.apache.jackrabbit.core.query.lucene.QueryResultImpl.getResults(QueryResultImpl.java:291)\n\tat org.apache.jackrabbit.core.query.lucene.SingleColumnQueryResult.<init>(SingleColumnQueryResult.java:66)\n\tat org.apache.jackrabbit.core.query.lucene.QueryImpl.execute(QueryImpl.java:134)\n\tat org.apache.jackrabbit.core.query.QueryImpl$1.perform(QueryImpl.java:130)\n\tat org.apache.jackrabbit.core.query.QueryImpl$1.perform(QueryImpl.java:1)\n\tat org.apache.jackrabbit.core.session.SessionState.perform(SessionState.java:200)\n\tat org.apache.jackrabbit.core.query.QueryImpl.execute(QueryImpl.java:126)\n\tat org.apache.jackrabbit.core.security.user.IndexNodeResolver.findNodes(IndexNodeResolver.java:109)\n\tat org.apache.jackrabbit.core.security.user.UserManagerImpl.findAuthorizables(UserManagerImpl.java:498)\n\tat org.apache.jackrabbit.core.security.user.UserManagerImpl.findAuthorizables(UserManagerImpl.java:462)\n\tat org.apache.jackrabbit.core.security.user.UserManagerImplTest.testFindAuthorizableByRelativePath(UserManagerImplTest.java:560)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n\tat java.lang.reflect.Method.invoke(Unknown Source)\n\tat junit.framework.TestCase.runTest(TestCase.java:154)\n\tat junit.framework.TestCase.runBare(TestCase.java:127)\n\tat junit.framework.TestResult$1.protect(TestResult.java:106)\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\n\tat junit.framework.TestResult.run(TestResult.java:109)\n\tat junit.framework.TestCase.run(TestCase.java:118)\n\tat org.apache.jackrabbit.test.AbstractJCRTest.run(AbstractJCRTest.java:456)\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\n\tat org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:130)\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:467)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:683)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:390)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:197)\n\n",
    "hasPatch": true,
    "hasScreenshot": false,
    "id": "JCR-3082",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "JACKRABBIT",
    "project": "JACKRABBIT",
    "summary": "occasional index out of bounds exception while running UserManagerImplTest.testFindAuthorizableByRelativePath",
    "systemSpecification": true,
    "version": ""
}