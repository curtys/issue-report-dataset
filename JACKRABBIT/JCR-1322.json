{
    "comments": [
        {
            "author": "Jukka Zitting",
            "body": "Which database schema file are you using? The mssql.ddl file that you refer to was only included in Jackrabbit 1.4, but this issue is marked for 1.3.3.\n\nAlso, the mssql.ddl in Jackrabbit 1.4 creates all tables with upper case names and contains the initial INSERT to the GLOBAL_REVISION table.",
            "date": "2008-01-18T13:48:01.341+0000",
            "id": 0
        },
        {
            "author": "Vijai Kalyan",
            "body": "You are correct. The revision number should be 1.4. Our local version is 1.3.3 patched with the various changes.\n\nI am referring to the following lines in DatabaseJournal.java (http://svn.apache.org/repos/asf/jackrabbit/tags/1.4/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/journal/DatabaseJournal.java)\n\n        updateGlobalStmtSQL =\n                \"update \" + schemaObjectPrefix + \"GLOBAL_REVISION \" +\n                \"set revision_id = revision_id + 1\";\n        selectGlobalStmtSQL =\n                \"select revision_id \" +\n\nNote the lower case column names for 'revision_id'. These are created in upper case however.",
            "date": "2008-01-28T19:07:59.606+0000",
            "id": 1
        },
        {
            "author": "Jukka Zitting",
            "body": "You're right, good point!\n\nFixed as suggested in revision 628291. Merged to the 1.4 branch in revision 628294.",
            "date": "2008-02-16T13:35:03.489+0000",
            "id": 2
        }
    ],
    "component": "clustering, jackrabbit-core",
    "description": "After a call to Session::save, we observed that cluster information was not written to the ${schemaObjectPrefix}JOURNAL and ${schemaObjectPrefix}GLOBAL_REVISION tables. We tested against Oracle 10 database servers and MS Sql Server 2005 servers. The problem was noticed only with MS Sql Server 2005. \n\nInitially, the problem was masked since the test was written as part of our unit test environment and the exceptions generated by JDBC were not showing up in the logs. A separate test with was carried out as shown by the code below\n\n<pre>\nimport java.io.FileInputStream;\n\nimport javax.jcr.Node;\nimport javax.jcr.Repository;\nimport javax.jcr.Session;\nimport javax.jcr.SimpleCredentials;\n\nimport org.apache.jackrabbit.core.TransientRepository;\nimport org.apache.jackrabbit.core.config.RepositoryConfig;\n\npublic class Main\n{\n    public static void main(String[] args)\n        throws Exception\n    {\n        System.setProperty(\"org.apache.jackrabbit.core.cluster.node_id\", \"testid\");\n        \n        RepositoryConfig config = RepositoryConfig.create(new FileInputStream(\"repository.xml\"), \"repository\");\n        \n        Repository repository = new TransientRepository();\n        \n        Session session = repository.login(new SimpleCredentials(\"username\", \"password\".toCharArray()));\n        \n        Node root = session.getRootNode();\n        \n        root.addNode(\"node1\");\n        root.addNode(\"node2\");\n        root.addNode(\"node3\");\n        \n        session.save();\n    }\n}\n</pre>\n\nThe configuration file used to configure the repository is attached.\n\nAfter debugging this, we obtained the exceptions that were previously not visible. Note that, JackRabbit continues to run (is that because the cluster code is running in a separate thread?) even after this exception. The problem was that the 'revision_id' field did not exist. The mssql.ddl schema file sets up the table names in capitals. However, at least two of the SQL statements in DatabaseJournal use lower case table names. For example:-\n\n<pre>\n        updateGlobalStmt = con.prepareStatement(\n                \"update \" + schemaObjectPrefix + \"global_revision \" +\n                \"set revision_id = revision_id + 1\");\n        selectGlobalStmt = con.prepareStatement(\n                \"select revision_id \" +\n                \"from \" + schemaObjectPrefix + \"global_revision\");\n</pre>\n\nAn additional error is that the mssql.ddl file is missing the following:\n\n<pre>\n# Inserting the one and only revision counter record now helps avoiding race conditions\ninsert into ${schemaObjectPrefix}GLOBAL_REVISION VALUES(0)\n</pre>\n\nFixing the above two issues, fixed the problem with MS SQL Server 2005.",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "JCR-1322",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "JACKRABBIT",
    "project": "JACKRABBIT",
    "summary": "Cluster information is not persisted to database when connected to case sensitive MS SQL Server 2005",
    "systemSpecification": true,
    "version": "1.4"
}