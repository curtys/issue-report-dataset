{
    "comments": [
        {
            "author": "Ian Boston",
            "body": "Restarting the cluster node with the problem appears to clear the problem with no bad effects to the JCR,\n\nThere are no deadlocks reported on any threads on the locked nodes and other https requests that do not use the JCR are operating correctly. \n\nConnecting a Profiler like JProfiler to the JVM on startup indicates that there are no blocked threads, and no deadlocks are detected.\n\nAdding a mbean monitor thread to analyse the threads within the JVM indicates that there are no blocked threads when the node stops responding.\n\nIt does not look like this is a deadlock condition.",
            "date": "2007-05-18T07:44:56.726+0000",
            "id": 0
        },
        {
            "author": "Ian Boston",
            "body": "\nIf the mbean monitor code looks at waiting threads 2 threads are found to go into a permanent wait state.\n\nThe ClusterNode thread (used by the cluster node to replay journal entries) goes into a permanent wait state  on a RenetrantLock object within the LockManagerImpl\n\nThread ClusterNode-localhost2 waiting by EDU.oswego.cs.dl.util.concurrent.ReentrantLock@6c6ff1 ::WAITING at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.acquire(LockManagerImpl.java:599)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.nodeAdded(LockManagerImpl.java:838)\n\nAnd the HTTP threads all go into a permanent wait state  (when they access the JCR) in the AbstractJournal.lockAndSync on a WriterLock\n\nThread http-8580-Processor23 waiting by EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock@8065c9 ::WAITING at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474) \n     at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.journal.AbstractJournal.lockAndSync(AbstractJournal.java:228)\n     at org.apache.jackrabbit.core.journal.DefaultRecordProducer.append(DefaultRecordProducer.java:51) \n\n\nThe LockManagerImpl.acquire contains a for(;;) loop that will loop forever if the lock is not aquired, I am putting some debug in the catch to see if the loop is spinning or if the wait is forever.\n\n\nI will also try and tracedown the objects being waited on to see if they give any clues to what is effectively deadlocking.\n",
            "date": "2007-05-18T07:51:07.274+0000",
            "id": 1
        },
        {
            "author": "Ian Boston",
            "body": "The reverse pattern also appears,\n\nThe ClusterNode thread waiting in AbstractJournal.sync\n\nand the http threads waiting in the LockManagerImpl.aquire\n\n-----\n\nThe previous case was ClusterNode thread in LockManagerImpl.aquire \n\nand http thread waiting in AbstractJournal.lockAndSync\n\nThis indicates that both sets of threads interact with the locks in both places raising the potential for an interlock to happen.\n\nSince the AbstractJournal is the newer code, perhapse it should perform a LockManagerImpl aquire earlier than it does ?\n\n-----\n\nThere is no indication that the spin lock inside LockManagerImpl.aquire ever comes out of the wait condition, except on a interupt to the JVM, at which point it goes back into the aquire.\n\nThis prevents the JCR from shutting down since the shutdown operation also needs to aquire a lock.\n\nWill investicate the call tree to see if its possible to change the locking order to prevent the interlock without hitting performance",
            "date": "2007-05-18T08:19:05.812+0000",
            "id": 2
        },
        {
            "author": "Marcel Reutegger",
            "body": "Can you please attach the full stacktrace of the involved threads?",
            "date": "2007-05-21T09:16:32.583+0000",
            "id": 3
        },
        {
            "author": "Ian Boston",
            "body": "\nThere is a stack trace of a node locked in waiting, the HTTP are locked and every request to this node, that hits the http thread will block in the same wait pattern\n\n\n\n     Starting Thread Monitor ==================\nThread Transient File Reaper waiting by java.lang.ref.ReferenceQueue$Lock@4622f ::WAITING at org.apache.jackrabbit.util.TransientFileFactory$ReaperThread.run(TransientFileFactory.java:148)\nThread TP-Processor3 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@eb38d2 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread TP-Processor2 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@df787e ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread TP-Processor1 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@5fa15c ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor25 waiting by EDU.oswego.cs.dl.util.concurrent.ReentrantLock@5036f6 ::WAITING at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.acquire(LockManagerImpl.java:599)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.externalLock(LockManagerImpl.java:973)\n     at org.apache.jackrabbit.core.cluster.ClusterNode.process(ClusterNode.java:723)\n     at org.apache.jackrabbit.core.cluster.ClusterNode.consume(ClusterNode.java:910)\n     at org.apache.jackrabbit.core.journal.AbstractJournal.doSync(AbstractJournal.java:191)\n     at org.apache.jackrabbit.core.journal.AbstractJournal.lockAndSync(AbstractJournal.java:241)\n     at org.apache.jackrabbit.core.journal.DefaultRecordProducer.append(DefaultRecordProducer.java:51)\n     at org.apache.jackrabbit.core.cluster.ClusterNode$WorkspaceUpdateChannel.updateCreated(ClusterNode.java:466)\n     at org.apache.jackrabbit.core.state.SharedItemStateManager$Update.begin(SharedItemStateManager.java:530)\n     at org.apache.jackrabbit.core.state.SharedItemStateManager.beginUpdate(SharedItemStateManager.java:825)\n     at org.apache.jackrabbit.core.state.SharedItemStateManager.update(SharedItemStateManager.java:855)\n     at org.apache.jackrabbit.core.state.LocalItemStateManager.update(LocalItemStateManager.java:326)\n     at org.apache.jackrabbit.core.state.XAItemStateManager.update(XAItemStateManager.java:313)\n     at org.apache.jackrabbit.core.state.LocalItemStateManager.update(LocalItemStateManager.java:302)\n     at org.apache.jackrabbit.core.state.SessionItemStateManager.update(SessionItemStateManager.java:306)\n     at org.apache.jackrabbit.core.ItemImpl.save(ItemImpl.java:1214)\n     at org.apache.jackrabbit.core.NodeImpl.lock(NodeImpl.java:4070)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.lock(DavResourceImpl.java:685)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.doLock(AbstractWebdavServlet.java:689)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.execute(AbstractWebdavServlet.java:259)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.service(AbstractWebdavServlet.java:193)\n     at javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n     at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n     at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n     at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n     at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n     at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n     at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n     at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n     at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n     at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n     at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n     at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n     at java.lang.Thread.run(Thread.java:613)\nThread http-8580-Processor24 waiting by EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock@488a98 ::WAITING at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.journal.AbstractJournal.lockAndSync(AbstractJournal.java:228)\n     at org.apache.jackrabbit.core.journal.DefaultRecordProducer.append(DefaultRecordProducer.java:51)\n     at org.apache.jackrabbit.core.cluster.ClusterNode$WorkspaceLockChannel.unlocked(ClusterNode.java:637)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.internalUnlock(LockManagerImpl.java:338)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.unlock(LockManagerImpl.java:428)\n     at org.apache.jackrabbit.core.lock.XALockManager.unlock(XALockManager.java:103)\n     at org.apache.jackrabbit.core.NodeImpl.unlock(NodeImpl.java:4133)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.unlock(DavResourceImpl.java:739)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.doUnlock(AbstractWebdavServlet.java:710)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.execute(AbstractWebdavServlet.java:262)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.service(AbstractWebdavServlet.java:193)\n     at javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n     at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n     at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n     at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n     at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n     at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n     at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n     at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n     at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n     at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n     at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n     at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n     at java.lang.Thread.run(Thread.java:613)\nThread http-8580-Processor22 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@40eb2a ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor21 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@f45d1 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor20 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@b0cea2 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor19 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@ce1b2b ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor18 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@59c4c6 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor17 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@85ded7 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor16 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@e90ea7 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor15 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@c11ce0 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor14 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@4ecfa4 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor13 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@225841 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor12 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@d034cf ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor11 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@3b1da2 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor10 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@16b458 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor9 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@9a3769 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor8 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@abd36b ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor7 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@c54d06 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor6 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@43f502 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor5 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@8a7951 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor4 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@22da8f ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor3 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@3af3cb ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor2 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@5ba3ee ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8580-Processor1 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@67770f ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread ClusterNode-node2 waiting by EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$ReaderLock@aaab5d ::WAITING at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$ReaderLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$ReaderLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.journal.AbstractJournal.sync(AbstractJournal.java:160)\n     at org.apache.jackrabbit.core.cluster.ClusterNode.sync(ClusterNode.java:283)\n     at org.apache.jackrabbit.core.cluster.ClusterNode.run(ClusterNode.java:254)\n     at java.lang.Thread.run(Thread.java:613)\nThread IndexMerger waiting by org.apache.commons.collections.buffer.BlockingBuffer@7dfc02 ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread IndexMerger waiting by org.apache.commons.collections.buffer.BlockingBuffer@9d85b ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread ObservationManager waiting by org.apache.commons.collections.buffer.BlockingBuffer@5b60bf ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread Finalizer waiting by java.lang.ref.ReferenceQueue$Lock@99d183 ::WAITING\nThread Reference Handler waiting by java.lang.ref.Reference$Lock@1de95a ::WAITING\n     Done Thread Monitor ==================",
            "date": "2007-05-25T15:26:00.157+0000",
            "id": 4
        },
        {
            "author": "Ian Boston",
            "body": "\n\nIm not certain about this, but I think the aquire in te sync from the ClusterNode should be an attempt, and if it fails, it should back put and wait for the next cycle.\n\nI'll give it a go and see what happens\n\n",
            "date": "2007-05-25T15:51:29.559+0000",
            "id": 5
        },
        {
            "author": "Ian Boston",
            "body": "Doing that causes the ClusterNode thread to timeout but the 2 http threads go into waiting state, so they must be interlocking on waits somewhere. \n\nI cant really do an attempt in the main threads since if the operation doesnt get to the journal then it wont propagate, and doing a back off would have to back off far enough to undo the interlock.\n\n\nThe pattern looks slightly different now,  to I might have fixed the first problem.... sorry about all the long stack traces but  its going to be confusing if not in context.\n\n     Starting Thread Monitor ==================\nThread Transient File Reaper waiting by java.lang.ref.ReferenceQueue$Lock@8da92 ::WAITING at org.apache.jackrabbit.util.TransientFileFactory$ReaperThread.run(TransientFileFactory.java:148)\nThread Transient File Reaper waiting by java.lang.ref.ReferenceQueue$Lock@b410a ::WAITING at org.apache.jackrabbit.util.TransientFileFactory$ReaperThread.run(TransientFileFactory.java:148)\nThread TP-Processor3 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@64886c ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread TP-Processor2 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@388e0b ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread TP-Processor1 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@f59ac1 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor25 waiting by EDU.oswego.cs.dl.util.concurrent.ReentrantLock@eb5563 ::WAITING at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.acquire(LockManagerImpl.java:599)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.nodeAdded(LockManagerImpl.java:840)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.onEvent(LockManagerImpl.java:745)\n     at org.apache.jackrabbit.core.observation.EventConsumer.consumeEvents(EventConsumer.java:231)\n     at org.apache.jackrabbit.core.observation.ObservationDispatcher.dispatchEvents(ObservationDispatcher.java:201)\n     at org.apache.jackrabbit.core.observation.EventStateCollection.dispatch(EventStateCollection.java:424)\n     at org.apache.jackrabbit.core.state.SharedItemStateManager$Update.end(SharedItemStateManager.java:721)\n     at org.apache.jackrabbit.core.state.SharedItemStateManager.update(SharedItemStateManager.java:855)\n     at org.apache.jackrabbit.core.state.LocalItemStateManager.update(LocalItemStateManager.java:326)\n     at org.apache.jackrabbit.core.state.XAItemStateManager.update(XAItemStateManager.java:313)\n     at org.apache.jackrabbit.core.state.LocalItemStateManager.update(LocalItemStateManager.java:302)\n     at org.apache.jackrabbit.core.state.SessionItemStateManager.update(SessionItemStateManager.java:306)\n     at org.apache.jackrabbit.core.ItemImpl.save(ItemImpl.java:1214)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.addMember(DavResourceImpl.java:517)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.doPut(AbstractWebdavServlet.java:504)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.execute(AbstractWebdavServlet.java:241)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.service(AbstractWebdavServlet.java:193)\n     at javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n     at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n     at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n     at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n     at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n     at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n     at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n     at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n     at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n     at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n     at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n     at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n     at java.lang.Thread.run(Thread.java:613)\nThread http-8080-Processor23 waiting by EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock@bd12a5 ::WAITING at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.WriterPreferenceReadWriteLock$WriterLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.journal.AbstractJournal.lockAndSync(AbstractJournal.java:233)\n     at org.apache.jackrabbit.core.journal.DefaultRecordProducer.append(DefaultRecordProducer.java:51)\n     at org.apache.jackrabbit.core.cluster.ClusterNode$WorkspaceLockChannel.unlocked(ClusterNode.java:637)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.internalUnlock(LockManagerImpl.java:338)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.unlock(LockManagerImpl.java:428)\n     at org.apache.jackrabbit.core.lock.XALockManager.unlock(XALockManager.java:103)\n     at org.apache.jackrabbit.core.NodeImpl.unlock(NodeImpl.java:4133)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.unlock(DavResourceImpl.java:739)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.doUnlock(AbstractWebdavServlet.java:710)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.execute(AbstractWebdavServlet.java:262)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.service(AbstractWebdavServlet.java:193)\n     at javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n     at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n     at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n     at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n     at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n     at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n     at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n     at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n     at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n     at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n     at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n     at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n     at java.lang.Thread.run(Thread.java:613)\nThread http-8080-Processor22 waiting by EDU.oswego.cs.dl.util.concurrent.ReentrantLock@eb5563 ::WAITING at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.acquire(LockManagerImpl.java:599)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.getLockInfo(LockManagerImpl.java:356)\n     at org.apache.jackrabbit.core.lock.XALockManager.isLocked(XALockManager.java:143)\n     at org.apache.jackrabbit.core.NodeImpl.isLocked(NodeImpl.java:4161)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.getLock(DavResourceImpl.java:648)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.initProperties(DavResourceImpl.java:312)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.getProperties(DavResourceImpl.java:271)\n     at org.apache.jackrabbit.webdav.MultiStatusResponse.<init>(MultiStatusResponse.java:180)\n     at org.apache.jackrabbit.webdav.MultiStatus.addResourceProperties(MultiStatus.java:62)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.doPropFind(AbstractWebdavServlet.java:435)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.execute(AbstractWebdavServlet.java:232)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.service(AbstractWebdavServlet.java:193)\n     at javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n     at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n     at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n     at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n     at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n     at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n     at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n     at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n     at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n     at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n     at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n     at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n     at java.lang.Thread.run(Thread.java:613)\nThread http-8080-Processor21 waiting by EDU.oswego.cs.dl.util.concurrent.ReentrantLock@eb5563 ::WAITING at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at java.lang.Object.wait(Object.java:-2)\n     at java.lang.Object.wait(Object.java:474)\n     at EDU.oswego.cs.dl.util.concurrent.ReentrantLock.acquire(null:-1)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.acquire(LockManagerImpl.java:599)\n     at org.apache.jackrabbit.core.lock.LockManagerImpl.getLockInfo(LockManagerImpl.java:356)\n     at org.apache.jackrabbit.core.lock.XALockManager.isLocked(XALockManager.java:143)\n     at org.apache.jackrabbit.core.NodeImpl.isLocked(NodeImpl.java:4161)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.getLock(DavResourceImpl.java:648)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.isLocked(DavResourceImpl.java:855)\n     at org.apache.jackrabbit.webdav.simple.DavResourceImpl.addMember(DavResourceImpl.java:501)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.doPut(AbstractWebdavServlet.java:504)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.execute(AbstractWebdavServlet.java:241)\n     at org.apache.jackrabbit.server.AbstractWebdavServlet.service(AbstractWebdavServlet.java:193)\n     at javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n     at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n     at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n     at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n     at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n     at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n     at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n     at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n     at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n     at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n     at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n     at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n     at java.lang.Thread.run(Thread.java:613)\nThread http-8080-Processor20 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@42de17 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor19 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@2ea67 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor18 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@6b1a74 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor17 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@95dc5a ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor16 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@b5cc4d ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor15 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@77e923 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor14 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@6afba3 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor13 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@ae8c15 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor12 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@6eea56 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor11 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@daf576 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor10 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@293c5e ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor9 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@3a774f ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor8 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@6efb3f ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor7 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@30e551 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor6 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@1f6576 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor5 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@3e2817 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor4 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@ba1328 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor3 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@3fbf92 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor2 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@3a3c1f ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread http-8080-Processor1 waiting by org.apache.tomcat.util.threads.ThreadPool$ControlRunnable@4127c0 ::WAITING at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:656)\nThread IndexMerger waiting by org.apache.commons.collections.buffer.BlockingBuffer@44b625 ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread IndexMerger waiting by org.apache.commons.collections.buffer.BlockingBuffer@a7252d ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread ObservationManager waiting by org.apache.commons.collections.buffer.BlockingBuffer@79d52f ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread IndexMerger waiting by org.apache.commons.collections.buffer.BlockingBuffer@8088da ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread IndexMerger waiting by org.apache.commons.collections.buffer.BlockingBuffer@7000ea ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread ObservationManager waiting by org.apache.commons.collections.buffer.BlockingBuffer@4c15d9 ::WAITING at org.apache.commons.collections.buffer.BlockingBuffer.remove(BlockingBuffer.java:107)\nThread Finalizer waiting by java.lang.ref.ReferenceQueue$Lock@c31c7d ::WAITING\nThread Reference Handler waiting by java.lang.ref.Reference$Lock@9c7650 ::WAITING\n     Done Thread Monitor ==================\n\n\n\n",
            "date": "2007-05-25T16:07:11.098+0000",
            "id": 6
        },
        {
            "author": "Ian Boston",
            "body": "\n\nThe thread that is in the Abstract Journal aquired a lock in the LockManagerImpl at about line 313 (1.3 TAG in svn) and then went into AbsracctJournal.lockAndSync via the cluster node.\n\nAll the other threads are waiting for this lock to be released prior to continuing, this is ok,\n\nsince there are no other threads waiting, I can only think that something is not releasing the journal lock in AbscractJournal (thankfully these are singletons !)",
            "date": "2007-05-25T16:22:10.615+0000",
            "id": 7
        },
        {
            "author": "Ian Boston",
            "body": "\n\nI am seeing some collisions on the revision numbers. Which causes the local cache to become out of date.... but looking at the code paths, there is always an release operation.",
            "date": "2007-05-25T17:41:09.054+0000",
            "id": 8
        },
        {
            "author": "Ian Boston",
            "body": "2 Log files, node 1 has locked up,\n\nIt appears to be locked after being unable to deliver lock event,\n\nwhich looks like it was caused by a revision collision.\n\n",
            "date": "2007-05-25T17:52:20.046+0000",
            "id": 9
        },
        {
            "author": "Dominique Pfister",
            "body": "Hi Ian,\n\nthank you for your stack traces and all your work! In your second thread dump, I'd say that the first one (Thread http-8080-Processor25) still holds the AbstractJournal's RWLock (acquired in SharedItemStateManager$Update.begin) and therefore the VM's state is similar to the first thread dump you provided: one thread holds the AbstractJournal's RWLock and will start an item update (1), while other threads interoperate with the LockManager and therefore lock that one (2). When the item update (1) triggers a synchronization on the journal (because another instance made some changes) it might encounter a lock operation and will try to inform the LockManager about this event. Because of all other threads in (2) this will cause the deadlock.\n\nIMO, to solve this problem, LockManager operations will have to adopt the same pattern as SharedItemStateManager updates already do: lock-and-sync the journal when the operation starts, unlock at the end of it.\n\nKind regards\nDominique",
            "date": "2007-05-29T07:48:58.818+0000",
            "id": 10
        },
        {
            "author": "Ian Boston",
            "body": "Dominique,\n\nthanks for the pointer, that makes sense to me and fits other problems I am seeing where locks fail on non existent nodes during journal replay.\n\n\nI will give it a go and get back to you. Unfortunately, I will not have full network access until this Saturday.\n\nThanks\nIan\n\nSent from my Pearl, sorry about the briefness and spelling!  \n\n",
            "date": "2007-05-29T11:30:17.158+0000",
            "id": 11
        },
        {
            "author": "Ian Boston",
            "body": "That appears to have fixed this problem,  in the internal lock and unlock methods I have added an effective lockAndSync if and only if the event channel is notified of the lock or unlock which would cause a lock and sync after the lock manager jvm lock had been aquired. So deadlocks can't happen as you predicted.\n\nI notice there may be some more places where this can happen.\n \nThe NodeTypeRegistry and the NameSpaceRegistry \n\nI have some additional errors appearing when the path can't be built due to nonexistant child nodes, leading me to believe that something might be being dropped.\n\nUnfortunately, I don't have net access and my blackberry won't hook up to OSX so I can't send a patch till Saturday at the earliest. Sorry\n\nIan\n\nSent from my Pearl, sorry about the briefness and spelling!  \n\n",
            "date": "2007-05-30T08:22:15.832+0000",
            "id": 12
        },
        {
            "author": "Xiaohua Lu",
            "body": "I had a similar problem but the stack trace is slight different \nThe setup is a 4 nodes cluster and under heavy load (mainly updates), they all hang, from database side, three transaction updates are waiting for a select lock. The select lock seems to be blocked by one of the threads underneath\n\nthread 1 \nThread 25141: (state = BLOCKED)\n - java.lang.Object.wait(long) @bci=0 (Compiled frame; information may be imprecise)\n - java.lang.Object.wait() @bci=2, line=474 (Compiled frame)\n - org.apache.jackrabbit.core.journal.AbstractJournal.sync() @bci=9, line=160 (Compiled frame)\n - org.apache.jackrabbit.core.cluster.ClusterNode.sync() @bci=27, line=283 (Interpreted frame)\n - org.apache.jackrabbit.core.cluster.ClusterNode.run() @bci=38, line=254 (Interpreted frame)\n - java.lang.Thread.run() @bci=11, line=595 (Interpreted frame)\n\n\nthread 2 \nThread 25137: (state = BLOCKED)\n - org.apache.commons.collections.map.AbstractHashedMap.get(java.lang.Object) @bci=62, line=182 (Compiled frame; information may be imprecise)\n - org.apache.jackrabbit.core.state.NodeState.getReorderedChildNodeEntries() @bci=57, line=671 (Compiled frame)\n - org.apache.jackrabbit.core.CachingHierarchyManager.nodesReplaced(org.apache.jackrabbit.core.state.NodeState) @bci=1, line=385 (Interpreted frame)\n - org.apache.jackrabbit.core.state.StateChangeDispatcher.notifyNodesReplaced(org.apache.jackrabbit.core.state.NodeState) @bci=29, line=132 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SessionItemStateManager.nodesReplaced(org.apache.jackrabbit.core.state.NodeState) @bci=29, line=874 (Interpreted frame)\n - org.apache.jackrabbit.core.state.NodeState.notifyNodesReplaced() @bci=12, line=793 (Interpreted frame)\n - org.apache.jackrabbit.core.state.NodeState.setChildNodeEntries(java.util.List) @bci=73, line=473 (Interpreted frame)\n - org.apache.jackrabbit.core.state.NodeStateMerger.merge(org.apache.jackrabbit.core.state.NodeState, org.apache.jackrabbit.core.state.NodeStateMerger$MergeContext) @bci=291, line=139 (Compiled frame)\n - org.apache.jackrabbit.core.state.SessionItemStateManager.stateModified(org.apache.jackrabbit.core.state.ItemState) @bci=58, line=802 (Interpreted frame)\n - org.apache.jackrabbit.core.state.StateChangeDispatcher.notifyStateModified(org.apache.jackrabbit.core.state.ItemState) @bci=29, line=85 (Interpreted frame)\n - org.apache.jackrabbit.core.state.LocalItemStateManager.stateModified(org.apache.jackrabbit.core.state.ItemState) @bci=49, line=427 (Interpreted frame)\n - org.apache.jackrabbit.core.state.StateChangeDispatcher.notifyStateModified(org.apache.jackrabbit.core.state.ItemState) @bci=29, line=85 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SharedItemStateManager.stateModified(org.apache.jackrabbit.core.state.ItemState) @bci=5, line=390 (Interpreted frame)\n - org.apache.jackrabbit.core.state.ItemState.notifyStateUpdated() @bci=12, line=241 (Interpreted frame)\n - org.apache.jackrabbit.core.state.ChangeLog.persisted() @bci=30, line=271 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SharedItemStateManager.doExternalUpdate(org.apache.jackrabbit.core.state.ChangeLog) @bci=264, line=945 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SharedItemStateManager.externalUpdate(org.apache.jackrabbit.core.state.ChangeLog, org.apache.jackrabbit.core.observation.EventStateCollection) @bci=10, line=871 (Interpreted frame)\n - org.apache.jackrabbit.core.RepositoryImpl$WorkspaceInfo.externalUpdate(org.apache.jackrabbit.core.state.ChangeLog, java.util.List) @bci=25, line=1957 (Interpreted frame)\n - org.apache.jackrabbit.core.cluster.ClusterNode.end() @bci=182, line=834 (Interpreted frame)\n - org.apache.jackrabbit.core.cluster.ClusterNode.consume(org.apache.jackrabbit.core.journal.Record) @bci=469, line=929 (Compiled frame)\n - org.apache.jackrabbit.core.journal.AbstractJournal.doSync(long) @bci=108, line=191 (Compiled frame)\n - org.apache.jackrabbit.core.journal.AbstractJournal.lockAndSync() @bci=42, line=241 (Interpreted frame)\n - org.apache.jackrabbit.core.journal.DefaultRecordProducer.append() @bci=6, line=51 (Interpreted frame)\n - org.apache.jackrabbit.core.cluster.ClusterNode$WorkspaceUpdateChannel.updateCreated(org.apache.jackrabbit.core.cluster.Update) @bci=36, line=466 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SharedItemStateManager$Update.begin() @bci=44, line=530 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SharedItemStateManager.beginUpdate(org.apache.jackrabbit.core.state.ChangeLog, org.apache.jackrabbit.core.observation.EventStateCollectionFactory, org.apache.jackrabbit.core.virtual.VirtualItemStateProvider) @bci=15, line=825 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SharedItemStateManager.update(org.apache.jackrabbit.core.state.ChangeLog, org.apache.jackrabbit.core.observation.EventStateCollectionFactory) @bci=4, line=855 (Interpreted frame)\n - org.apache.jackrabbit.core.state.LocalItemStateManager.update(org.apache.jackrabbit.core.state.ChangeLog) @bci=9, line=326 (Interpreted frame)\n - org.apache.jackrabbit.core.state.XAItemStateManager.update(org.apache.jackrabbit.core.state.ChangeLog) @bci=20, line=313 (Interpreted frame)\n - org.apache.jackrabbit.core.state.LocalItemStateManager.update() @bci=22, line=302 (Interpreted frame)\n - org.apache.jackrabbit.core.state.SessionItemStateManager.update() @bci=4, line=306 (Interpreted frame)\n - org.apache.jackrabbit.core.ItemImpl.save() @bci=594, line=1214 (Interpreted frame)\n - net.maven.mcr.event.AssetCompleteEventListener.markAssetComplete(javax.jcr.Node, boolean) @bci=137, line=185 (Interpreted frame)\n - net.maven.mcr.event.AssetCompleteEventListener.handleAssetCompleteCheck(java.lang.String) @bci=241, line=169 (Interpreted frame)\n - net.maven.mcr.event.AssetCompleteEventListener.onEvent(javax.jcr.observation.EventIterator) @bci=112, line=82 (Interpreted frame)\n - org.apache.jackrabbit.core.observation.EventConsumer.consumeEvents(org.apache.jackrabbit.core.observation.EventStateCollection) @bci=165, line=231 (Compiled frame)\n - org.apache.jackrabbit.core.observation.ObservationDispatcher.run() @bci=104, line=145 (Interpreted frame)\n - java.lang.Thread.run() @bci=11, line=595 (Interpreted frame)\n\n\nSince Thread 2 is blocked by JVM lock, it is also holding the select lock in doSync.getRecords. That explained the deadlock on database level. \n\nI am not sure these two problems are exactly the same, if not, I can file a seperate bug. Thanks.\n\n\n\n",
            "date": "2007-06-01T17:03:45.714+0000",
            "id": 13
        },
        {
            "author": "Ian Boston",
            "body": "I now have a patch for this which I will upload on saturday night, currently out of network range.\n\nIan\n\nSent from my Pearl, sorry about the briefness and spelling!  \n\n",
            "date": "2007-06-01T18:40:17.814+0000",
            "id": 14
        },
        {
            "author": "Ian Boston",
            "body": "This is my patch that appears to fix this problem.\n\nIts not what I would call perfect since it may be too wide, and the patch may not apply as there are some line shifts where I have other logging statements in the files.",
            "date": "2007-06-02T15:54:11.639+0000",
            "id": 15
        },
        {
            "author": "Dominique Pfister",
            "body": "Hi Ian,\n\nthank you for looking at this problem and providing a patch! I'll take a look at it asap. I will possibly extend the o.a.j.c.cluster.LockEventChannel to provide the locking functionality you added in order not to expose the ClusterNode class directly to the LockManagerImpl.\n\nKind regards\nDominique",
            "date": "2007-06-04T09:17:29.567+0000",
            "id": 16
        },
        {
            "author": "Dominique Pfister",
            "body": "Hi Ian,\n\nI implemented your changes, introducing a new interface ClusterOperation that hides the details of locking (unlocking) the journal before (after) some cluster operation starts (ends), which will be useful for nodetype/namespace operations as well. I've attached a patch file that should be directly applied to the jackrabbit 1.3 sources (patch -p0 < patch.544769) and I'd be grateful if you could test whether this patch resolves this issue.\n\nKind regards\nDominique",
            "date": "2007-06-06T09:25:22.377+0000",
            "id": 17
        },
        {
            "author": "Ian Boston",
            "body": "Yes you patch fixes the problem.... its also much cleaner and my gut feeling is that its quicker\n\nThanks\n",
            "date": "2007-06-07T08:36:46.919+0000",
            "id": 18
        },
        {
            "author": "Ian Boston",
            "body": "There is one small failiure in teh tests when not in a cluster \nAbout line 324\n\n    void internalUnlock(NodeImpl node)\n            throws LockException, RepositoryException {\n\n    \t\n        ClusterOperation operation = null;\n        if ( eventChannel != null ) {\n        \toperation = eventChannel.create(node.getNodeId());\n        }\n        boolean successful = false;\n\n        acquire();\n\n\n",
            "date": "2007-06-09T10:05:49.807+0000",
            "id": 19
        },
        {
            "author": "Dominique Pfister",
            "body": "Thanks Ian, for pointing out that one! Tests now pass smoothly. \n\nFixed in revision 546038.",
            "date": "2007-06-11T08:12:53.840+0000",
            "id": 20
        },
        {
            "author": "Jukka Zitting",
            "body": "Merged to the 1.3 branch in revision 558172.",
            "date": "2007-07-20T22:12:33.663+0000",
            "id": 21
        }
    ],
    "component": "jackrabbit-core",
    "description": "Under Heavy load created by mounting both nodes in the cluster in OSX Finder and then uploading large numebers of files to each node at the same time ( a few 1000), eventually one of the nodes stops responding and the Finder mount timesout and disconnects.\n\nOnce that happens that node becomes unusable.\nMore mount attempts will prompt for a password indicating HTTP is still running, but will timeout once the connection is authenticated.\nAccess by the Web Browser will prompt for a password, conenct and provide a once only listing of any collection in the workspace. If you try to refresh that collection, the HTTP request hangs forever.",
    "hasPatch": true,
    "hasScreenshot": false,
    "id": "JCR-929",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "JACKRABBIT",
    "project": "JACKRABBIT",
    "summary": "Under Heavy load in a Cluster HTTP Threads Block and stall requests",
    "systemSpecification": true,
    "version": "1.3"
}