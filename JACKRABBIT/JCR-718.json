{
    "comments": [
        {
            "author": "Jaka Jaksic",
            "body": "IMO this is a bug. Jackrabbit should not check for permissions on deleted items, or it should check them _before_ removing the item from hierarchy manager.\n\nI have the following workaround code in isGranted method (see the comment):\n\n        try {\n            final QName name = hierarchyManager.getName(id);\n            ...\n        } catch (ItemNotFoundException e) {\n            // Deleted items can not be resolved by hierarchy\n            // manager (because they no longer exist), but they\n            // must be allowed access for deletion to succeed.\n            return true;\n        }\n",
            "date": "2007-01-24T21:48:37.771+0000",
            "id": 0
        },
        {
            "author": "Tobias Bocanegra",
            "body": "btw: have a look at PathFormat.format() it does exactly what you need.",
            "date": "2007-01-26T09:09:02.177+0000",
            "id": 1
        },
        {
            "author": "Stefan Guggisberg",
            "body": "> is it really a bug or am i wrong? \n\nit is indeed a bug and you're absolutely right :-)\n\nthe problem is that the provided hierarchy manager doesn't check the attic containing the transiently removed items.\n\nthanks for reporting this issue!\n\ncheers\nstefan",
            "date": "2007-01-26T17:03:27.266+0000",
            "id": 2
        },
        {
            "author": "Stefan Guggisberg",
            "body": "fixed in svn r507601\n\nadded NamespaceResolver to AMContext for conveniant path formatting,\ne.g. \n\n    String path = PathFormat.format(hierMgr.getPath(id), nsResolver);\n\n",
            "date": "2007-02-14T16:24:04.158+0000",
            "id": 3
        }
    ],
    "component": "jackrabbit-core",
    "description": "I'm using jackrabbit 1.2.1\nwith no versioning\nwith a very simple SimpleAccessManager (this try to compute the path of the passed ItemId and verify permissions over that path)\n\nwhen I remove a node (nt:file or nt:folder),  calling session.save() I obtains the exception reported below.\n\nis it really a bug or am i wrong?\nthanks\n\nthe following is the code I'm using to build the path\n----------------------------------------- CODE START\npublic String getStringPath(ItemId id) throws ItemNotFoundException, RepositoryException, NoPrefixDeclaredException\n\t{\n\t\tString p = \"\";\n\t\tNamespaceResolver nsResolver = ((HierarchyManagerImpl) hierMgr).getNamespaceResolver();\n\t\tPath path = hierMgr.getPath(id);\n\t\tPathElement[] pe = path.getElements();\n\t\tfor (int i = 0; i < pe.length; i++)\n\t\t{\n\t\t\tif (pe[i].denotesName())\n\t\t\t\tp += \"/\" + pe[i].toJCRName(nsResolver);\n\t\t}\n\t\treturn p;\n\t}\n----------------------------------------- CODE END\n\n\n----------------------------------------- START\njavax.jcr.ItemNotFoundException: failed to build path of d688e92f-26ae-4f7c-aba7-aaff1df62c2c: d688e92f-26ae-4f7c-aba7-aaff1df62c2c: d688e92f-26ae-4f7c-aba7-aaff1df62c2c\n\tat org.apache.jackrabbit.core.HierarchyManagerImpl.getPath(HierarchyManagerImpl.java:362)\n\tat org.apache.jackrabbit.core.CachingHierarchyManager.getPath(CachingHierarchyManager.java:224)\n\tat it.unict.faq.jackrabbit.SimpleAccessManager.getStringPath(SimpleAccessManager.java:238)\n\tat it.unict.faq.jackrabbit.SimpleAccessManager.controllo(SimpleAccessManager.java:215)\n\tat it.unict.faq.jackrabbit.SimpleAccessManager.isGranted(SimpleAccessManager.java:183)\n\tat org.apache.jackrabbit.core.ItemImpl.validateTransientItems(ItemImpl.java:645)\n\tat org.apache.jackrabbit.core.ItemImpl.save(ItemImpl.java:1162)\n\tat org.apache.jackrabbit.core.SessionImpl.save(SessionImpl.java:821)\n\tat it.unict.faq.driver.manager.impl.DAO.JcrDAO.CancellaNodo(JcrDAO.java:638)\n\tat it.unict.faq.driver.manager.impl.DocumentServerManager.ds_del(DocumentServerManager.java:58)\n\tat elearn.portal.action.ds_del_portal.execute(ds_del_portal.java:28)\n\tat org.apache.struts.action.RequestProcessor.processActionPerform(RequestProcessor.java:421)\n\tat org.apache.struts.action.RequestProcessor.process(RequestProcessor.java:226)\n\tat org.apache.struts.action.ActionServlet.process(ActionServlet.java:1158)\n\tat org.apache.struts.action.ActionServlet.doPost(ActionServlet.java:415)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:709)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:264)\n\tat org.acegisecurity.intercept.web.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:107)\n\tat org.acegisecurity.intercept.web.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:72)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:110)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.providers.anonymous.AnonymousProcessingFilter.doFilter(AnonymousProcessingFilter.java:125)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.rememberme.RememberMeProcessingFilter.doFilter(RememberMeProcessingFilter.java:142)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.wrapper.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:81)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.AbstractProcessingFilter.doFilter(AbstractProcessingFilter.java:217)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.logout.LogoutFilter.doFilter(LogoutFilter.java:108)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.context.HttpSessionContextIntegrationFilter.doFilter(HttpSessionContextIntegrationFilter.java:193)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.util.FilterChainProxy.doFilter(FilterChainProxy.java:148)\n\tat org.acegisecurity.util.FilterToBeanProxy.doFilter(FilterToBeanProxy.java:98)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n\tat org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n\tat org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n\tat org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n\tat org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n\tat java.lang.Thread.run(Thread.java:595)\nCaused by: org.apache.jackrabbit.core.state.NoSuchItemStateException: d688e92f-26ae-4f7c-aba7-aaff1df62c2c\n\tat org.apache.jackrabbit.core.state.SessionItemStateManager.getTransientItemState(SessionItemStateManager.java:323)\n\tat org.apache.jackrabbit.core.state.SessionItemStateManager.getItemState(SessionItemStateManager.java:154)\n\tat org.apache.jackrabbit.core.HierarchyManagerImpl.getItemState(HierarchyManagerImpl.java:120)\n\tat org.apache.jackrabbit.core.HierarchyManagerImpl.getPath(HierarchyManagerImpl.java:357)\n\t... 52 more\norg.apache.jackrabbit.core.state.NoSuchItemStateException: d688e92f-26ae-4f7c-aba7-aaff1df62c2c\n\tat org.apache.jackrabbit.core.state.SessionItemStateManager.getTransientItemState(SessionItemStateManager.java:323)\n\tat org.apache.jackrabbit.core.state.SessionItemStateManager.getItemState(SessionItemStateManager.java:154)\n\tat org.apache.jackrabbit.core.HierarchyManagerImpl.getItemState(HierarchyManagerImpl.java:120)\n\tat org.apache.jackrabbit.core.HierarchyManagerImpl.getPath(HierarchyManagerImpl.java:357)\n\tat org.apache.jackrabbit.core.CachingHierarchyManager.getPath(CachingHierarchyManager.java:224)\n\tat it.unict.faq.jackrabbit.SimpleAccessManager.getStringPath(SimpleAccessManager.java:238)\n\tat it.unict.faq.jackrabbit.SimpleAccessManager.controllo(SimpleAccessManager.java:215)\n\tat it.unict.faq.jackrabbit.SimpleAccessManager.isGranted(SimpleAccessManager.java:183)\n\tat org.apache.jackrabbit.core.ItemImpl.validateTransientItems(ItemImpl.java:645)\n\tat org.apache.jackrabbit.core.ItemImpl.save(ItemImpl.java:1162)\n\tat org.apache.jackrabbit.core.SessionImpl.save(SessionImpl.java:821)\n\tat it.unict.faq.driver.manager.impl.DAO.JcrDAO.CancellaNodo(JcrDAO.java:638)\n\tat it.unict.faq.driver.manager.impl.DocumentServerManager.ds_del(DocumentServerManager.java:58)\n\tat elearn.portal.action.ds_del_portal.execute(ds_del_portal.java:28)\n\tat org.apache.struts.action.RequestProcessor.processActionPerform(RequestProcessor.java:421)\n\tat org.apache.struts.action.RequestProcessor.process(RequestProcessor.java:226)\n\tat org.apache.struts.action.ActionServlet.process(ActionServlet.java:1158)\n\tat org.apache.struts.action.ActionServlet.doPost(ActionServlet.java:415)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:709)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:264)\n\tat org.acegisecurity.intercept.web.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:107)\n\tat org.acegisecurity.intercept.web.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:72)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:110)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.providers.anonymous.AnonymousProcessingFilter.doFilter(AnonymousProcessingFilter.java:125)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.rememberme.RememberMeProcessingFilter.doFilter(RememberMeProcessingFilter.java:142)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.wrapper.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:81)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.AbstractProcessingFilter.doFilter(AbstractProcessingFilter.java:217)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.ui.logout.LogoutFilter.doFilter(LogoutFilter.java:108)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.context.HttpSessionContextIntegrationFilter.doFilter(HttpSessionContextIntegrationFilter.java:193)\n\tat org.acegisecurity.util.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:274)\n\tat org.acegisecurity.util.FilterChainProxy.doFilter(FilterChainProxy.java:148)\n\tat org.acegisecurity.util.FilterToBeanProxy.doFilter(FilterToBeanProxy.java:98)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n\tat org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n\tat org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n\tat org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n\tat org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n\tat java.lang.Thread.run(Thread.java:595)\n----------------------------------------- END",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "JCR-718",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "Major",
    "product": "JACKRABBIT",
    "project": "JACKRABBIT",
    "summary": "NoSuchItemStateException on removing node (no versioning)",
    "systemSpecification": true,
    "version": "1.2.1"
}