{
    "comments": [
        {
            "author": null,
            "body": "Fixed.\n\nDIFFS:\n\nIndex: JSSESocketFactory.java\n===================================================================\nRCS file:\n/home/cvs/jakarta-tomcat-connectors/util/java/org/apache/tomcat/util/net/jsse/JSSESocketFactory.java,v\nretrieving revision 1.13\ndiff -u -r1.13 JSSESocketFactory.java\n--- JSSESocketFactory.java      24 Jan 2004 04:56:32 -0000      1.13\n+++ JSSESocketFactory.java      18 Feb 2004 22:39:36 -0000\n@@ -58,6 +58,7 @@\n  */ \n package org.apache.tomcat.util.net.jsse;\n \n+import java.io.File;\n import java.io.FileInputStream;\n import java.io.FileNotFoundException;\n import java.io.IOException;\n@@ -309,7 +310,13 @@\n         InputStream istream = null;\n         try {\n             ks = KeyStore.getInstance(type);\n-            istream = new FileInputStream(path);\n+            File keyStoreFile = new File(path);\n+            if (!keyStoreFile.isAbsolute()) {\n+                keyStoreFile = new File(System.getProperty(\"catalina.base\"),\n+                                        path);\n+            }\n+            istream = new FileInputStream(keyStoreFile);\n+\n             ks.load(istream, pass.toCharArray());\n             istream.close();\n             istream = null;",
            "date": "20040218T22:40:41",
            "id": 0
        }
    ],
    "component": "Connector:Coyote",
    "description": "Tomcat docs on configuring SSL says (on keystoreFile attribute of http\nConnector): \"You can specify an absolute pathname, or a relative pathname that\nis resolved against the $CATALINA_BASE environment variable.\" \n\nHowever, specifying relative keystoreFile does not make tomcat resolve this file\nagainst $CATALINA_BASE (or -Dcatalina.base property). It seems it is resolved\nagainst current working directory.\n\nHow to reproduce this error:\n1. install tomcat (as nt service)\n2. create separate (striped down) base (say <BASE>) somewhere on your disk\n(conf, logs, work, temp, webapps(empty) directories)\n3. create keystore <BASE>/conf/catalina.keystore\n4. update <BASE>/conf/server.xml to enable https connector as \n    <Connector port=\"9443\" \n     maxThreads=\"50\" minSpareThreads=\"5\" maxSpareThreads=\"25\"\n     enableLookups=\"false\" disableUploadTimeout=\"true\"\n     acceptCount=\"100\" debug=\"0\" scheme=\"https\" secure=\"true\"\n     clientAuth=\"false\" sslProtocol=\"TLS\" \n     keystoreFile=\"conf/catalina.keystore\"\n    />\n5. using tomcatw.exe\" //ES//Tomcat5 update \"java options\" so they reference new\nbase, particularly append -Dcatalina.base=\"<BASE>\" to \"Java Options\"\n6. net start tomcat5\n7. observe stdout.log\n2004-02-18 22:25:42 org.apache.coyote.http11.Http11Protocol init\nSEVERE: Error initializing endpoint\njava.io.FileNotFoundException: conf\\catalina.keystore (The system cannot find\nthe file specified)\n8. now, use tomcatw.exe\" //ES//Tomcat5 in order to update Service \"Work Path\" to\nrefer to the new base\n9. Now tomcat DOES start https and finds conf/catalina.keystore relative to the\nnew work dir\n\nHow to obtain this error (the easier way):\n1. unpack/install tomcat\n2. create separate (striped down) base (say <BASE>) somewhere on your disk (bin,\nconf, logs, work, temp, webapps(empty) directories)\n3. create keystore <BASE>/conf/catalina.keystore\n4. update <BASE>/conf/server.xml to enable https connector as \n    <Connector port=\"9443\" \n     maxThreads=\"50\" minSpareThreads=\"5\" maxSpareThreads=\"25\"\n     enableLookups=\"false\" disableUploadTimeout=\"true\"\n     acceptCount=\"100\" debug=\"0\" scheme=\"https\" secure=\"true\"\n     clientAuth=\"false\" sslProtocol=\"TLS\" \n     keystoreFile=\"conf/catalina.keystore\"\n    />\n5. open cmd\n6. set CATALINA_BASE=<BASE> (dir containing conf subdir)\n7. cd %CATALINA_BASE%\\bin\n8. catalina.bat start\n9. oops, we're still getting \n2004-02-18 22:25:42 org.apache.coyote.http11.Http11Protocol init\nSEVERE: Error initializing endpoint\njava.io.FileNotFoundException: conf\\catalina.keystore (The system cannot find\nthe file specified)\n10. cd ..\n11. bin\\catalina.bat start\n12. NO java.io.FNFE this time\n\nAll this leads me to the conclusion that keystoreFile attribute value is\nresolved against current working directory instaed of $CATALINA_BASE\nProbably truststoreFile attribute suffers from the same problem.\n\nTested on both j2sdk1.4.2_03 as well on j2sdk1.5.0-beta1",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "27050",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "P3 critical",
    "product": "Tomcat 5",
    "project": "TOMCAT",
    "summary": "keystoreFile parameter, when specified as relative, is not treated relative to $CATALINA_BASE or catalina.base property",
    "systemSpecification": true,
    "version": "5.0.19"
}