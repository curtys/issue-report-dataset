{
    "comments": [
        {
            "author": null,
            "body": "Ixnay on having special handling for a UserTransaction: I'd like all resources \nto be handled the same.\n\nPlease attach patches to the issue instead of entering them as part of the bug \ndescription itself.\n\nIf you post a .diff patch of your second proposed alternative, I'll be glad to \nlook at it.",
            "date": "20041022T17:23:15",
            "id": 0
        },
        {
            "author": null,
            "body": "Created attachment 13216\nAs oriented, solution (B) for a NamingContextListener patch",
            "date": "20041025T16:45:06",
            "id": 1
        },
        {
            "author": null,
            "body": "OK, patch (B) applied: thanks for submitting it.",
            "date": "20041029T14:03:43",
            "id": 2
        }
    ],
    "component": "Catalina",
    "description": "Hi,\n As of tomcat-5.0.29, it is not possible to have a\njava:/comp/UserTransaction resource working if declared from a\n<DefaultContext> ResourceLink. (ie) :\n.......\n<GlobalNamingResources>\n               <Resource name=\"UTransaction\" auth=\"Container\"\n               type=\"javax.transaction.UserTransaction\"/>\n               <ResourceParams name=\"UTransaction\">\n                       <parameter>\n                       <name>factory</name>\n                       <value>org.objectweb.jotm.UserTransactionFactory</value>\n                       </parameter>\n                       <parameter>\n                       <name>jotm.timeout</name>\n                       <value>60</value>\n                       </parameter>\n               </ResourceParams>\n</GlobalNamingResources>\n.......\n<Host>\n     <DefaultContext>\n              <ResourceLink name=\"UserTransaction\" global=\"UTransaction\"\n               type=\"javax.transaction.UserTransaction\"/>\n      </DefaultContext>\n</Host>\n.....\n\n As far as i have investigated the problem, <DefaultContext> resources\nare not avaliable as NamingResources when NamingContextListener\ncreates the NamingContext for the Context\n(NamingContextListener.createNamingContext()). So at the moment\nNamingContext (webapp is being loaded) is created, the java:/comp/UserTransation\nresource is\nadded with an empty TransactionRef object. Later, in the life cicle,\nwhen DefaultContext resources are added to the context, in this case a\nResourceLink pointing to the UserTransaction  global resource, we get\na NameAlreadyBoundException, so the previously registered\nTransactionRef object remains without config parameters.\n The UserTransaction works fine if included in each application's own\ncontext.xml file.\n\n There are, at least, two possible solutions for this issue, without messing\naround with WebAppLoader (<DefaultConxtext> has been rewriten for 5.5.x).\nWhich one should be taken (if) ?\n\n    A) one solution that does not interfere if an UserTransaction has\nbeen successfully registered by a <Context> element (more power to the\nweb-application) even if there is a UserTransaction Resource element in a\n<DefaultContext>. This is the solution I've made a patch for, and IMHO makes\nmore sense regarding a <DefaultContext> concept. It is attached in the end of\nthis report.\n\n    B) if a UserTransaction is present in a <DefaultContext>, it will\nbe the available one. This behavior is the current behavior for the\nStandardDefaultContext implementation regarding all resources inside a\n<DefaultContext> (yes, the implementation unregisters previous\nresources from <Context> initializations per web-application, and\noverride them with equally named resources (if) available inside a\n<DefaultContext> for a <Host>). I have a possible patch proposal for this, but\ndid not investigated (tested) it yet.\n\n I haven't found any notes regarding this anywhere (manual,\nlist and Bugzilla).\n\nThanks.\n\n-----------------BEGIN\n\n--- jakarta-tomcat-5.0.29-src/jakarta-tomcat-catalina/catalina/src/share/org/apa\nche/catalina/core/NamingContextListener.java    2004-10-22 11:38:27.000000000 -0\n200\n+++ NamingContextListener.java  2004-10-22 11:35:23.000000000 -0200\n@@ -33,6 +33,7 @@\n import org.apache.catalina.ContainerEvent;\n import org.apache.catalina.ContainerListener;\n import org.apache.catalina.Context;\n+import org.apache.catalina.DefaultContext;\n import org.apache.catalina.Lifecycle;\n import org.apache.catalina.LifecycleEvent;\n import org.apache.catalina.LifecycleListener;\n@@ -898,14 +899,56 @@\n         javax.naming.Context ctx = \n             \"UserTransaction\".equals(resourceLink.getName()) \n             ? compCtx : envCtx;\n+         int try_again = 0;\n         try {\n             if (debug >= 2)\n                 log(\"  Adding resource link \" + resourceLink.getName());\n             createSubcontexts(envCtx, resourceLink.getName());\n             ctx.bind(resourceLink.getName(), ref);\n         } catch (NamingException e) {\n-            log(sm.getString(\"naming.bindFailed\", e));\n-        }\n+               if (container instanceof Context \n+                       && \"UserTransaction\".equals(resourceLink.getName()) ) {\n+                       try_again = 1;\n+               } else log(sm.getString(\"naming.bindFailed\", e));\n+        }\n+       if (try_again == 1) {\n+         // As DefaultContext resources are not avaliable\n+         // at NamingContext initialization, lets give\n+         // it a chance to register a UserTransaction\n+         // if the initialized one stills empty\n+               try {\n+                       if ( debug >=2 )\n+                               log(\"  Trying again adding \" + resourceLink.getN\name() + \" now from DefaultContext\");\n+                       Object orig_ref = compCtx.lookup(\"UserTransaction\");\n+                       if ( debug >=2 )\n+                               log(\"  Got initial UserTransaction Reference\"); \n+                        try_again = 0;\n+               } catch (NamingException e) {\n+                   // Initial UserTransaction empty\n+                       try_again = 1;\n+               }\n+\n+               if (try_again == 1) {\n+                       try {\n+                               if (debug >=2 )\n+                                       log(\"  Trying to unbind initial UserTran\nsaction Reference\"); \n+                               ctx.unbind(\"UserTransaction\");\n+                               if (debug >=2 )\n+                                       log(\"  Unbinding empty UserTransaction \"\n); \n+                       } catch (NamingException e) {\n+                       // Nothing to be done\n+                       }\n+               }\n+               // Either way, at this point,  or we are \n+               // registering the DefaultContext\n+               // UserTransaction Ref, or it will throw the right\n+               // NameAlreadyBoudException\n+               try {\n+                       ctx.bind(resourceLink.getName(), ref);\n+               } catch (NamingException e) {\n+                       log(sm.getString(\"naming.bindFailed\", e));\n+               }\n+        }\n \n     }\n\n-------------------END",
    "hasPatch": true,
    "hasScreenshot": false,
    "id": "31851",
    "issuetypeClassified": "RFE",
    "issuetypeTracker": "BUG",
    "priority": "P3 normal",
    "product": "Tomcat 5",
    "project": "TOMCAT",
    "summary": "UserTransaction not working if declared inside a  DefaultContext",
    "systemSpecification": true,
    "version": "5.0.29"
}