{
    "comments": [
        {
            "author": null,
            "body": "Here is what causes the problem:\n\nin TcpReplicationThread line 142 the call to key.interestedOps blocks until the\nselect in the parallel execution of ReplicationListener returns the next time. \nI checked with adding debug output directly nefore and after.\n\nInternet sources confirm, that register and setting interestedOps are blocking \non select to the same selector.\n\nSome people suggest putting wakeup directly before register and interstedOps, \nbut since an interrupted select in ReplicationListener will very quickly do the \nnext select, I think you need some way of informing ReplicationListener to not \ndo the select until interestedOps has returned.\n",
            "date": "20040407T14:50:46",
            "id": 0
        },
        {
            "author": null,
            "body": "Why would you set tcpSelectorTimeout to 1000ms?\n\nThe tcpSelectorTimeout feature is in place because of a bug in java NIO. If \nyour NIO is working bug free, then tcpSelectorTimeout should be 0, cause the \nselector should wake up by itself when it receives a package. In many Unix \nJDKs this is not the case, hence you can set it to 50ms.\n\nI am setting this to INVALID, cause 1000ms in tcpSelectorTimeout is wrong. The \nproblem is in Java NIO, not in Tomcat, hence you have to set \ntcpSelectorTimeout to a reasonable value. On windows you can set to 0, no \ntimeout, cause on windows NIO works well, and the selector wakes up by itself \nwhen a data packet arrives\n\n\nFilip",
            "date": "20040407T14:55:15",
            "id": 1
        },
        {
            "author": null,
            "body": "I'm having a different opinion: it is well documented, that key.interestedOps() \nblocks waiting for select() to return - dependent on the JVM implementation. It \nis not a bug in the JVM!\n\nYou call interestedOps() in TcpReplicationThread line 142 although there is a \nparallelly executing select() call in ReplicationListener. So the interestedOps\n() blocks the TcPReplicationThread until the select() in ReplicationListener \nreturns. Since during that time OP_READ is not set, select might block a very \nlong time.\n\nOf course setting tcpSelectorTimeout to a very small value looks like a \nworkaround. But still it is not a safe solution: depending on the scheduling of \nthreads on CPUs it might happen, that ReplicationListener calls select() again, \nbefore interestedOps() is able to set the new flags.\n\nI really think you need a design, \n- where you check for pending interestedOps or register calls before retrying \nselect\n- where you \"register\" interestedOps or register calls as pending, afterwards \ncall wakeup, then do the interestedOps or register call and \nfinally \"unregister\" the calls.\n\n",
            "date": "20040407T15:13:14",
            "id": 2
        },
        {
            "author": null,
            "body": "Reopened - reason see my 2 last comments. tcpSelectorTimeout was only chosen so \nbig to demonstrate the bug.",
            "date": "20040407T15:36:34",
            "id": 3
        },
        {
            "author": null,
            "body": "Yes, you are absolutely right, the interestOps in unix is blocking until \nselect is done.\n\nI will fix this, many thanks for the detailed bug report",
            "date": "20040407T16:13:45",
            "id": 4
        },
        {
            "author": null,
            "body": "Thank you very much! I hope I don't bother you too much, but we plan to use TC\n5.0 cluster in a high load mission critical application starting June. So we try\nhard to help you improve robustness.\n\nI think you do a wonderful job and we try to be as precise as possible with our\nobservations.",
            "date": "20040407T18:09:52",
            "id": 5
        },
        {
            "author": null,
            "body": "As always, I stand corrected about interestOps blocking. This has been fixed,\nhowever, setting tcpSelectorTimeout to 1000ms will still yield the same \nproblems because of selector.select() will not wake up if new data comes in on \nthe tcp channel.",
            "date": "20040407T19:06:11",
            "id": 6
        }
    ],
    "component": "Catalina:Cluster",
    "description": "In a TC cluster with synchronous replication there is a bug in using select() \nand registering operations on selectors.\n\nIf I use a high tcpSelectorTimeout (e.g. 1000ms) I can observe the secondary \nnode waiting in the midlle of a request until the timeout occurs, although \nreplication data is available. As a consequence requests take 1 second to work \non, although only the TC instances need only 20ms to process the request.\nNearly 1 second is spend waiting for select() to return in the middle of \nprocessing the request.\n\nI assume this is a bug in the logic handling the registration of operations on \nthe selector?\n\nIt is not a problem of high load, one can observe using single requests,\nbut it is necessary to use session atributes in the request.\n\nI expect the same problem to occur in pooled mode. The problem does not \nincrease response times in asynchronous mode, but I expect, that it will\nincrease replication time.\n\nHere is a protocol of what is happening. Most of these log lines are non \nstandard, I added them to the code, to find out the flow of control in this \nsituation. The intersting thing happens between step 5 and 6.\n\n1) Node 1: Request coming in at 12:39:32,563 :\n\n2004-04-07 12:39:32,563 (http-21080-Processor25)\norg.apache.catalina.core.StandardWrapper/DEBUG:   Returning non-STM instance\n2004-04-07 12:39:32,564 (http-21080-Processor25)\norg.apache.jasper.servlet.JspServlet/DEBUG: JspEngine --> /repit.jsp\n2004-04-07 12:39:32,564 (http-21080-Processor25)\norg.apache.jasper.servlet.JspServlet/DEBUG:         ServletPath: /repit.jsp\n2004-04-07 12:39:32,564 (http-21080-Processor25)\norg.apache.jasper.servlet.JspServlet/DEBUG:            PathInfo: null\n2004-04-07 12:39:32,564 (http-21080-Processor25)\norg.apache.jasper.servlet.JspServlet/DEBUG:            RealPath:\n/opt/iob3_tomcat_a/webapps/ROOT/repit.jsp\n2004-04-07 12:39:32,564 (http-21080-Processor25)\norg.apache.jasper.servlet.JspServlet/DEBUG:          RequestURI: /repit.jsp\n2004-04-07 12:39:32,564 (http-21080-Processor25)\norg.apache.jasper.servlet.JspServlet/DEBUG:         QueryString: null\n2004-04-07 12:39:32,564 (http-21080-Processor25)\norg.apache.jasper.servlet.JspServlet/DEBUG:      Request Params:\n\n2) Node 1: New session message EVT_SESSION_CREATED is being send at \n12:39:32,567:\n\n2004-04-07 12:39:32,566 (http-21080-Processor25)\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: Sending \nEVT_SESSION_CREATED:\nSending creation of Session with  id=CD25AAD154CC01843779EA36B143D101.mkbtomcat1\nisValid=true isNew=true accessCount=0 maxInactiveInterval=900 \nisPrimarySession=true\ncreationTime=1081334372565 lastAccessedTime=1081334372565\nlastTimeReplicated=1081334372565\n2004-04-07 12:39:32,566 (http-21080-Processor25)\norg.apache.catalina.cluster.tcp.SimpleTcpCluster/DEBUG: Starting\nCatalinaCluster.send for msg 1 session \nCD25AAD154CC01843779EA36B143D101.mkbtomcat1\nand destination null\n\n3) Node 2: Message is being received at 12:39:32,568, sending ack at \n12:39:32,573:\n\n2004-04-07 12:39:32,568 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\nlisten in while doListen after select returned n=1\n2004-04-07 12:39:32,568 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener \nwoke\nup in listen\n2004-04-07 12:39:32,568 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\ncalling serviceChannel from readDataFromSocket in TcpReplicationThread\n2004-04-07 12:39:32,568 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ncalling notify in serviceChannel\n2004-04-07 12:39:32,568 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\nlisten in while doListen before select with tcpSelectorTimeout=1000\n2004-04-07 12:39:32,569 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\nwoke up with key sun.nio.ch.SelectionKeyImpl@b3f9b8\n2004-04-07 12:39:32,569 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\nwoke up and calling drainChannel for key sun.nio.ch.SelectionKeyImpl@b3f9b8\n2004-04-07 12:39:32,569 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\nStarting drainChannel for key sun.nio.ch.SelectionKeyImpl@b3f9b8\n2004-04-07 12:39:32,569 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ndrainChannel inner loop has count 401 and pkgcnt 1\n2004-04-07 12:39:32,571 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: Manager () Received\nSessionMessage of type=SESSION-MODIFIED from\norg.apache.catalina.cluster.mcast.McastMember\n[tcp://10.254.65.100:5002,10.254.65.100,5002,\nalive=230840]\n2004-04-07 12:39:32,572 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: Created a DeltaSession \nwith\nId[A981679B5BD40B418ED57F874DF8E1ED.mkbtomcat2] Total count=5\n2004-04-07 12:39:32,573 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: Receiving\nEVT_SESSION_CREATED: Overwriting new Session with \nid=CD25AAD154CC01843779EA36B143D101.mkbtomcat1 isValid=true isNew=false\naccessCount=0 maxInactiveInterval=900 isPrimarySession=false\ncreationTime=1081334372572 lastAccessedTime=1081334372572\nlastTimeReplicated=1081334372571\n2004-04-07 12:39:32,573 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ndrainChannel has pkgcnt 1\n2004-04-07 12:39:32,573 (p.TcpReplicationThread[2])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ndrainChannel sending ack for pkgcnt 1\n\nImportant: ClusterReceiver calls select() again at 12:39:32,568. This is the \nplace\nwhere now all the time goes by.\n\n4) Node 1: Received ack and proceeds with session.access() at 12:39:32,573. Ends\nsession.access() at 12:39:32,574:\n\n2004-04-07 12:39:32,573 (http-21080-Processor25)\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: Created a DeltaSession \nwith\nId[CD25AAD154CC01843779EA36B143D101.mkbtomcat1] Total count=5\n2004-04-07 12:39:32,574 (http-21080-Processor25)\norg.apache.catalina.cluster.session.DeltaManager/INFO : End of session.access in\nid=CD25AAD154CC01843779EA36B143D101.mkbtomcat1 isNew=false\nlastAccessedTime=1081334372565 thisAccessedTime=1081334372574 accessCount=1\n\n5) Node 1: Proceeds working on request until Delta message of type \nEVT_SESSION_DELTA\n is being sent at 12:39:32,578:\n\n2004-04-07 12:39:32,576 (http-21080-Processor25)\norg.apache.catalina.cluster.tcp.ReplicationValve/DEBUG: Invoking replication \nrequest\non /repit.jsp\n2004-04-07 12:39:32,577 (http-21080-Processor25)\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: DeltaManager request\nCompleted sending EVT_SESSION_DELTA  \nid=CD25AAD154CC01843779EA36B143D101.mkbtomcat1\nisValid=true isNew=false accessCount=1 maxInactiveInterval=900 \nisPrimarySession=true\ncreationTime=1081334372565 lastAccessedTime=1081334372565\nlastTimeReplicated=1081334372565\n2004-04-07 12:39:32,577 (http-21080-Processor25)\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: DeltaManager request\nCompleted returns with msg non null\n2004-04-07 12:39:32,577 (http-21080-Processor25)\norg.apache.catalina.cluster.tcp.SimpleTcpCluster/DEBUG: Starting\nCatalinaCluster.send for msg 13 session \nCD25AAD154CC01843779EA36B143D101.mkbtomcat1\nand destination null\n2004-04-07 12:39:32,577 (http-21080-Processor25)\norg.apache.catalina.cluster.tcp.SimpleTcpCluster/DEBUG: Setting msgID in\nCatalinaCluster.send for msg 13 session \nCD25AAD154CC01843779EA36B143D101.mkbtomcat1\nand destination null to ABC9CBA\n2004-04-07 12:39:32,578 (http-21080-Processor25)\norg.apache.catalina.cluster.tcp.SimpleTcpCluster/DEBUG: Calling\nclusterSender.sendMessage for msg 13 session\nCD25AAD154CC01843779EA36B143D101.mkbtomcat1 ID ABC9CBA and destination NULL\n\n6) Now there is no activity for 993 milliseconds - which is the problem - until \n1003\nmilliseconds after the last call to select() in ClusterReceiver on node 2, \nalthough\nthere is one message of type EVT_SESSION_DELTA  waiting to be read. Finally the\nselect returns at 12:39:33,571 but with n=0 and another immediate call to select\n()\nreturns instantaneously with n=1. From here on everything proceeds normal, the\nmessage is being read and ack is sent at 12:39:33,577:\n\n2004-04-07 12:39:33,571 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\nlisten in while doListen after select returned n=0\n2004-04-07 12:39:33,571 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\nlisten in while doListen before select with tcpSelectorTimeout=1000\n2004-04-07 12:39:33,571 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\nlisten in while doListen after select returned n=1\n2004-04-07 12:39:33,571 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\nwokeup in listen\n2004-04-07 12:39:33,571 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\ncalling serviceChannel from readDataFromSocket in TcpReplicationThread\n2004-04-07 12:39:33,571 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ncalling notify in serviceChannel\n2004-04-07 12:39:33,571 (ClusterReceiver)\norg.apache.catalina.cluster.tcp.ReplicationListener/DEBUG: ReplicationListener\nlisten in while doListen before select with tcpSelectorTimeout=1000\n2004-04-07 12:39:33,571 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\nwoke up with key sun.nio.ch.SelectionKeyImpl@b3f9b8\n2004-04-07 12:39:33,572 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\nwoke up and calling drainChannel for key sun.nio.ch.SelectionKeyImpl@b3f9b8\n2004-04-07 12:39:33,572 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\nStarting drainChannel for key sun.nio.ch.SelectionKeyImpl@b3f9b8\n2004-04-07 12:39:33,572 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ndrainChannel inner loop has count 540 and pkgcnt 1\n2004-04-07 12:39:33,574 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.tcp.SimpleTcpCluster/DEBUG: Received in\nclusterSender.messageDataReceived msg 13 session\nCD25AAD154CC01843779EA36B143D101.mkbtomcat1\n2004-04-07 12:39:33,574 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: Manager () Received\nSessionMessage of type=SESSION-DELTA from\norg.apache.catalina.cluster.mcast.McastMember\n[tcp://10.254.65.100:5002,10.254.65.100,5002,\nalive=230851]\n2004-04-07 12:39:33,576 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.session.DeltaManager/INFO : End of session.access in\nid=CD25AAD154CC01843779EA36B143D101.mkbtomcat1 isNew=false\nlastAccessedTime=1081334372572 thisAccessedTime=1081334373575 accessCount=1\n2004-04-07 12:39:33,576 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.session.DeltaManager/INFO : End of \nsession.endAccess in\nid=CD25AAD154CC01843779EA36B143D101.mkbtomcat1 isNew=false\nlastAccessedTime=1081334372572 thisAccessedTime=1081334373575 accessCount=0\n2004-04-07 12:39:33,577 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.session.DeltaManager/DEBUG: Receiving \nEVT_SESSION_DELTA:\nUpdating Session with  id=CD25AAD154CC01843779EA36B143D101.mkbtomcat1 \nisValid=true\nisNew=false accessCount=0 maxInactiveInterval=900 isPrimarySession=false\ncreationTime=1081334372572 lastAccessedTime=1081334372572\nlastTimeReplicated=1081334372571\n2004-04-07 12:39:33,577 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ndrainChannel has pkgcnt 1\n2004-04-07 12:39:33,577 (p.TcpReplicationThread[1])\norg.apache.catalina.cluster.tcp.TcpReplicationThread/DEBUG: TcpReplicationThread\ndrainChannel sending ack for pkgcnt 1\n\n7) The ack is seen on node 1 at 12:39:33,579 and session.endAccess() ends the\nprocessing of the request\n\n2004-04-07 12:39:33,579 (http-21080-Processor25)\norg.apache.catalina.cluster.session.DeltaManager/INFO : End of \nsession.endAccess in\nid=CD25AAD154CC01843779EA36B143D101.mkbtomcat1 isNew=false\nlastAccessedTime=1081334372565 thisAccessedTime=1081334372574 accessCount=0",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "28259",
    "issuetypeClassified": "IMPROVEMENT",
    "issuetypeTracker": "BUG",
    "priority": "P3 normal",
    "product": "Tomcat 5",
    "project": "TOMCAT",
    "summary": "Synchronous cluster very slow - select() bug",
    "systemSpecification": true,
    "version": "5.0.21"
}