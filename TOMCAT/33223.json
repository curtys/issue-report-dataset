{
    "comments": [],
    "component": "Jasper",
    "description": "We have a tag library which we use on JSP pages. The Page tag forwards to a\ncontroller (via pageContext.forward() which then redirects to a template page\nand the template page includes via <jsp-include> the site navigation etc. then\nincludes  via <jsp-include> the original request page. This works in Tomcat 4\nbut it throws an exception in Tomcat 5 - I tried with 5.5.4.\n\nIn debugging this, I found the problem is JspServlet:service which tries to call \n\nif (requestUri != null){\n                String currentIncludedUri \n                    = requestUri.substring(requestUri.indexOf(includeUri));\n\nwith the values:\nincludeUri= \"/test/index.jsp\"\nrequestUri= \"/tomcat-bug/test/\"\n\nSince includeUri does not appear in requestUri, indexOf returns -1 and this\ncauses a runtime exception.\n\nThis occurs because my webapp has index.jsp in the web.xml welcome-file-list,\nbut when the initial page is being executed, request.getRequestURI() returns the\n requested page, not the resolved welcome page. For example, \n\nHere is a simplified example showing how to reproduce. I deployed this in the\nwebapp context \"tomcat-bug\" on Tomcat 5.5.4 with no front end web server -\nTomcat is running as the web server. I removed the tag libraries and other\ninfrastructure and created simple JSP files that demonstrate the root problem,\nso no classes or jars are required in WEB-INF/lib or WEB-INF/classes. \n\nURL:  http://localhost:8080/tomcat-bug/test/\nNote: I don't get the exception with the URL\nhttp://localhost:8080/tomcat-bug/test/index.jsp, only when the page is resolved\nvia the welcome-file\n\nWeb application files:\n\ntest/index.jsp:\n\n<%\n  Boolean included = (Boolean) pageContext.getAttribute(\"template.running\",\nPageContext.REQUEST_SCOPE);\n  if (included == null)\n  {\n    String uri = request.getRequestURI();\n    String path = request.getContextPath();\n    if (path != null && uri.startsWith(path))\n       uri = uri.substring(path.length());\n    pageContext.setAttribute(\"template.body\", uri, PageContext.REQUEST_SCOPE);\n    pageContext.forward(\"/templates/template.jsp\");\n  }\n  else\n  {\n%>\n\n<p>This is my JSP page, test/index.jsp. This is the body/content of the page.</p>\n\n<%\n  }\n%>\n<!-- end of test/index.jsp -->\n\ntemplates/template.jsp:\n\n<%\n    pageContext.setAttribute(\"template.running\", Boolean.TRUE,\nPageContext.REQUEST_SCOPE);\n    String top = \"/templates/top.jsp\";\n    String body = (String) pageContext.getAttribute(\"template.body\",\nPageContext.REQUEST_SCOPE);\n%>\n\n<html>\n<head><title>Tomcat bug</title></head>\n<body>\n\n<jsp:include flush=\"true\" page=\"<%=top%>\"></jsp:include>\n<br/>\nBody:\n<jsp:include flush=\"true\" page=\"<%=body%>\"></jsp:include>\n:body\n</body>\n</html>\n<!-- end of templates/template.jsp -->\n\ntemplates/top.jsp :\n<p>This is the top navigation bar for the page template (top.jsp)<p>\n<!-- end of templates/top.jsp -->\n\nWEB-INF/web.xml:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<web-app version=\"2.4\" \n\txmlns=\"http://java.sun.com/xml/ns/j2ee\" \n\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" \n\txsi:schemaLocation=\"http://java.sun.com/xml/ns/j2ee \n\thttp://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd\">\n\n\t<welcome-file-list>\n\t\t<welcome-file>index.jsp</welcome-file>\n\t</welcome-file-list>\n  \n</web-app>",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "33223",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "P2 normal",
    "product": "Tomcat 5",
    "project": "TOMCAT",
    "summary": "pageContext.forward and <jsp:include> result in StringIndexOutOfBoundsException",
    "systemSpecification": true,
    "version": "5.5.4"
}