{
    "comments": [
        {
            "author": null,
            "body": "Analysis of the problem:\nIn ValveBase::createObjectName line 292, host is expected to have a non-null \nvalue. This will happen only if parent has been set for the current Context \nthat has a Valve definition.\n\nThis call can be traced back to org.apache.catalina.core.ContainerBase.addValve\n(ContainerBase.java:1306), which can be further traced back to \norg.apache.commons.digester.SetNextRule.end(SetNextRule.java:256).\n\nIf we look at ContextRuleSet::addRuleInstances, (line 248) statement:\ndigester.addObjectCreate(prefix + \"Context/Valve\",\n                                 null, // MUST be specified in the element\n                                 \"className\");\nis setting the corresponding Rule whose later execution (*end*) leads to NPE.\n\nAnother statement in same method (line 164):\n            digester.addSetNext(prefix + \"Context\",\n                                \"addChild\",\n                                \"org.apache.catalina.Container\");\nis responsible for correctly setting the parent-child relationship between Host \nand the current Context. But before the *end* of this Rule can be called, the \n*end* of the previous Rule gets called leading to NPE.\n\nHence, if we decide to retain the statement (line 291) \nHost host = (Host) container.getParent(); \nin ValveBase::createObjectName, then we should make sure that this call would \nreturn a non-null Host reference.\n\nOne of the ways to achieve this is the following modification:\n--------------------------------------------------------------------\n--- Tomcat5.0.4\\jakarta-tomcat-\ncatalina\\catalina\\src\\share\\org\\apache\\catalina\\startup\\SetDocBaseRule.java\n\tMon Jul 14 20:54:26 2003\n+++ Modified\\Tomcat5.0.4\\jakarta-tomcat-\ncatalina\\catalina\\src\\share\\org\\apache\\catalina\\startup\\SetDocBaseRule.java\n\tWed Jul 23 17:13:10 2003\n@@ -127,6 +127,8 @@\n         }\n         String appBase = host.getAppBase();\n \n+        child.setParent(host);\n+\n         if (!(host instanceof StandardHost)) {\n             return;\n         }\n---------------------------------------------------------------------\n\nAn additional call to child.setParent(host) in *begin* will make sure that \nlater call to getParent() returns a non-null Host reference.\n\nOf course, there could be other ways to fix this problem.",
            "date": "20030723T11:55:27",
            "id": 0
        },
        {
            "author": null,
            "body": "Yes, there was one last bug with discrepancies between the pipeline lifecycle\nand the JMX registration of the valves.\nHopefully, that's the last bug of this kind (I had fixed a similar, more serious\nbug, in 5.0.3).",
            "date": "20030723T13:37:48",
            "id": 1
        },
        {
            "author": null,
            "body": "Verified the fix in StandardPipeline. It works fine.",
            "date": "20030724T04:39:25",
            "id": 2
        }
    ],
    "component": "Catalina",
    "description": "This was working in Tomcat 4.1.18, but is not working in 5.0.3 and 5.0.4\n\nPlacing a Valve inside the Context for admin.xml as follows:\n-------------------------------------------------------------------\n<Context path=\"/admin\" docBase=\"../server/webapps/admin\"\n        debug=\"0\" privileged=\"true\">\n \n  <Logger className=\"org.apache.catalina.logger.FileLogger\"\n             prefix=\"localhost_admin_log.\" suffix=\".txt\"\n          timestamp=\"true\"/>\n\n  <Valve className=\"org.apache.catalina.valves.RequestDumperValve\"/>\n\n</Context>\n-------------------------------------------------------------------\ngives following Null Pointer Exception:\n\nJul 23, 2003 10:08:42 AM org.apache.catalina.core.StandardHostDeployer install\nINFO: Installing web application from Config file URL file:D:\\Tomcat5.0.4\n\\jakarta-tomcat-5\\build\\conf\\Catalina\\localhost\\admin.xml\nJul 23, 2003 10:08:43 AM org.apache.catalina.core.StandardPipeline registerValve\nINFO: Can't register valve RequestDumperValve[/admin]\njava.lang.NullPointerException\n        at org.apache.catalina.valves.ValveBase.createObjectName\n(ValveBase.java:292)\n        at org.apache.catalina.core.StandardPipeline.registerValve\n(StandardPipeline.java:357)\n        at org.apache.catalina.core.StandardPipeline.addValve\n(StandardPipeline.java:492)\n        at org.apache.catalina.core.ContainerBase.addValve\n(ContainerBase.java:1306)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:324)\n        at org.apache.commons.beanutils.MethodUtils.invokeMethod\n(MethodUtils.java:252)\n        at org.apache.commons.digester.SetNextRule.end(SetNextRule.java:256)\n        at org.apache.commons.digester.Rule.end(Rule.java:276)\n        at org.apache.commons.digester.Digester.endElement(Digester.java:1058)\n        at org.apache.crimson.parser.Parser2.maybeElement(Parser2.java:1536)\n        at org.apache.crimson.parser.Parser2.content(Parser2.java:1779)\n        at org.apache.crimson.parser.Parser2.maybeElement(Parser2.java:1507)\n        at org.apache.crimson.parser.Parser2.parseInternal(Parser2.java:500)\n        at org.apache.crimson.parser.Parser2.parse(Parser2.java:305)\n        at org.apache.crimson.parser.XMLReaderImpl.parse(XMLReaderImpl.java:442)\n        at org.apache.commons.digester.Digester.parse(Digester.java:1567)\n        at org.apache.catalina.core.StandardHostDeployer.install\n(StandardHostDeployer.java:515)\n        at org.apache.catalina.core.StandardHost.install(StandardHost.java:869)\n        at org.apache.catalina.startup.HostConfig.deployDescriptors\n(HostConfig.java:519)\n        at org.apache.catalina.startup.HostConfig.deployApps\n(HostConfig.java:470)\n        at org.apache.catalina.startup.HostConfig.start(HostConfig.java:920)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent\n(HostConfig.java:399)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent\n(LifecycleSupport.java:166)\n        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1135)\n        at org.apache.catalina.core.StandardHost.start(StandardHost.java:795)\n        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1127)\n        at org.apache.catalina.core.StandardEngine.start\n(StandardEngine.java:502)\n        at org.apache.catalina.core.StandardService.start\n(StandardService.java:519)\n        at org.apache.catalina.core.StandardServer.start\n(StandardServer.java:2312)\n        at org.apache.catalina.startup.Catalina.start(Catalina.java:577)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:324)\n        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:297)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:394)\nJul 23, 2003 10:08:43 AM org.apache.struts.util.PropertyMessageResources <init>\nINFO: Initializing, config='org.apache.struts.util.LocalStrings', \nreturnNull=true\n-------------------------------------------------------------------------\nGot same exception when placed a Context having a Valve inside server.xml.\nPlacing a Valve inside a Host seems to work fine.",
    "hasPatch": false,
    "hasScreenshot": false,
    "id": "21822",
    "issuetypeClassified": "BUG",
    "issuetypeTracker": "BUG",
    "priority": "P3 major",
    "product": "Tomcat 5",
    "project": "TOMCAT",
    "summary": "Placing a Valve inside a Context gives Null Pointer Exception...",
    "systemSpecification": false,
    "version": "5.0.4"
}